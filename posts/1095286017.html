<!DOCTYPE HTML><html lang="zh-CN"><head><meta charset="utf-8"><meta name="keywords" content="【MySQL学习】9.锁, Back-End Dev Java"><meta name="description" content="1 InnoDB中的锁在MySQL官方文档中（version 5.7），InnoDB中有以下几种锁：

Shared and Exclusive Locks：共享（乐观）锁、排他/互斥/独占锁
Intention Locks：意向锁
Rec"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no"><meta name="renderer" content="webkit|ie-stand|ie-comp"><meta name="mobile-web-app-capable" content="yes"><meta name="format-detection" content="telephone=no"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="referrer" content="no-referrer-when-downgrade"><title>【MySQL学习】9.锁 | Kezade</title><link rel="icon" type="image/jpeg" href="https://gcore.jsdelivr.net/gh/zyxelva/zyxelva.github.io@main/medias/avatar/avatar2.jpg"><style>body{background-image:url(https://it-ark-dev.oss-cn-shenzhen.aliyuncs.com/464e9ac7a5a729ae67f91f7cf0cf6fe2.jpg);background-repeat:no-repeat;background-attachment:fixed;background-size:cover;background-position:center center}</style><link rel="stylesheet" href="https://gcore.jsdelivr.net/gh/zyxelva/zyxelva.github.io@main/libs/awesome/css/all.min.css"><link rel="stylesheet" href="https://gcore.jsdelivr.net/gh/zyxelva/zyxelva.github.io@main/libs/materialize/materialize.min.css"><link rel="stylesheet" href="https://gcore.jsdelivr.net/gh/zyxelva/zyxelva.github.io@main/libs/aos/aos.css"><link rel="stylesheet" href="https://gcore.jsdelivr.net/gh/zyxelva/zyxelva.github.io@main/libs/animate/animate.min.css"><link rel="stylesheet" href="https://gcore.jsdelivr.net/gh/zyxelva/zyxelva.github.io@main/libs/lightGallery/css/lightgallery.min.css"><link rel="stylesheet" href="https://gcore.jsdelivr.net/gh/zyxelva/picgo@v3.1/css/matery.css?v3"><link rel="stylesheet" href="https://gcore.jsdelivr.net/gh/zyxelva/zyxelva.github.io@main/css/my.css"><link rel="stylesheet" href="https://gcore.jsdelivr.net/gh/zyxelva/zyxelva.github.io@main/css/dark.css" media="none" onload='"all"!=media&&(media="all")'><link rel="stylesheet" href="https://gcore.jsdelivr.net/gh/zyxelva/zyxelva.github.io@main/libs/tocbot/tocbot.css"><link rel="stylesheet" href="https://gcore.jsdelivr.net/gh/zyxelva/zyxelva.github.io@main/css/post.css"><link rel="stylesheet" href="https://gcore.jsdelivr.net/gh/zyxelva/zyxelva.github.io@main/css/reward.css"><script src="https://gcore.jsdelivr.net/gh/zyxelva/zyxelva.github.io@main/libs/jquery/jquery-3.6.0.min.js"></script><script src="https://gcore.jsdelivr.net/gh/zyxelva/picgo@v3.3/js/function.js?v88"></script><script src="https://gcore.jsdelivr.net/gh/zyxelva/picgo@v1.3/js/imgStatus.min.js"></script><script src="https://gcore.jsdelivr.net/gh/zyxelva/picgo@v1.3/js/waterfall.min.js"></script><script src="https://gcore.jsdelivr.net/gh/zyxelva/picgo@v1.3/js/lately.min.js"></script><script>var memos={host:"https://s.dusays.com/",limit:"10",creatorId:"49",username:"zyxelva",name:"Kezade",domId:"#memos",path:"api/v1/memo"},douban={api:"https://douban-api.edui.fun/"}</script><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/rss2.xml" title="Kezade" type="application/rss+xml"></head><body><header class="navbar-fixed"><nav id="headNav" class="bg-color nav-transparent"><div id="navContainer" class="nav-wrapper container"><div class="brand-logo"><a href="/" class="waves-effect waves-light"><img src="https://gcore.jsdelivr.net/gh/zyxelva/zyxelva.github.io@main/medias/avatar/avatar2.jpg" class="logo-img k-avatar" alt="LOGO"> <span class="logo-span">Kezade</span></a></div><a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a><ul class="right nav-menu"><li class="hide-on-med-and-down nav-item"><a href="/" class="waves-effect waves-light"><i class="fas fa-home" style="zoom:0.6"></i> <span>首页</span></a></li><li class="hide-on-med-and-down nav-item"><a href="" class="waves-effect waves-light"><i class="fa-solid fa-newspaper" style="zoom:0.6"></i> <span>文章</span><i class="fas fa-chevron-down" aria-hidden="true" style="zoom:0.6"></i></a><ul class="sub-nav menus_item_child"><li><a href="/tags"><i class="fas fa-tags" style="margin-top:-20px;zoom:0.6"></i> <span>标签</span></a></li><li><a href="/categories"><i class="fas fa-bookmark" style="margin-top:-20px;zoom:0.6"></i> <span>分类</span></a></li><li><a href="/archives"><i class="fas fa-archive" style="margin-top:-20px;zoom:0.6"></i> <span>归档</span></a></li></ul></li><li class="hide-on-med-and-down nav-item"><a href="" class="waves-effect waves-light"><i class="fa-solid fa-sitemap" style="zoom:0.6"></i> <span>系列</span><i class="fas fa-chevron-down" aria-hidden="true" style="zoom:0.6"></i></a><ul class="sub-nav menus_item_child"><li><a href="/categories/%E7%AE%97%E6%B3%95"><i class="fa-solid fa-rocket" style="margin-top:-20px;zoom:0.6"></i> <span>算法学习</span></a></li><li><a href="/categories/RocketMQ%E5%AD%A6%E4%B9%A0"><i class="fa-solid fa-rocket" style="margin-top:-20px;zoom:0.6"></i> <span>RMQ学习</span></a></li><li><a href="/categories/Netty%E5%AD%A6%E4%B9%A0"><i class="fa-solid fa-rocket" style="margin-top:-20px;zoom:0.6"></i> <span>Netty学习</span></a></li><li><a href="/categories/Spring%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0"><i class="fa-solid fa-rocket" style="margin-top:-20px;zoom:0.6"></i> <span>Spring学习</span></a></li><li><a href="/categories/JVM%E5%AD%A6%E4%B9%A0"><i class="fa-solid fa-rocket" style="margin-top:-20px;zoom:0.6"></i> <span>JVM学习</span></a></li><li><a href="/categories/MySQL%E5%AD%A6%E4%B9%A0"><i class="fa-solid fa-rocket" style="margin-top:-20px;zoom:0.6"></i> <span>MySQL学习</span></a></li><li><a href="/categories/MyBatis%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0"><i class="fa-solid fa-rocket" style="margin-top:-20px;zoom:0.6"></i> <span>MyBatis学习</span></a></li><li><a href="/categories/Zookeeper%E5%AD%A6%E4%B9%A0"><i class="fa-solid fa-rocket" style="margin-top:-20px;zoom:0.6"></i> <span>ZK学习</span></a></li><li><a href="/categories/Hexo"><i class="fa-solid fa-rocket" style="margin-top:-20px;zoom:0.6"></i> <span>Hexo学习</span></a></li><li><a href="/categories/Redis%E5%AD%A6%E4%B9%A0"><i class="fa-solid fa-rocket" style="margin-top:-20px;zoom:0.6"></i> <span>Redis学习</span></a></li><li><a href="/categories/Docker%E5%AD%A6%E4%B9%A0"><i class="fa-solid fa-rocket" style="margin-top:-20px;zoom:0.6"></i> <span>Docker学习</span></a></li><li><a href="/categories/AP-Calculus"><i class="fa-solid fa-rocket" style="margin-top:-20px;zoom:0.6"></i> <span>AP学习</span></a></li><li><a href="/categories/A-Level"><i class="fa-solid fa-rocket" style="margin-top:-20px;zoom:0.6"></i> <span>A-Level学习</span></a></li><li><a href="/categories/SAT"><i class="fa-solid fa-rocket" style="margin-top:-20px;zoom:0.6"></i> <span>SAT学习</span></a></li><li><a href="/categories/%E8%80%83%E7%A0%94"><i class="fa-solid fa-rocket" style="margin-top:-20px;zoom:0.6"></i> <span>考研</span></a></li><li><a href="/categories/OSSD"><i class="fa-solid fa-rocket" style="margin-top:-20px;zoom:0.6"></i> <span>OSSD</span></a></li><li><a href="/categories/%E9%AB%98%E8%80%83"><i class="fa-solid fa-rocket" style="margin-top:-20px;zoom:0.6"></i> <span>高考</span></a></li></ul></li><li class="hide-on-med-and-down nav-item"><a href="" class="waves-effect waves-light"><i class="fa-solid fa-place-of-worship" style="zoom:0.6"></i> <span>我的</span><i class="fas fa-chevron-down" aria-hidden="true" style="zoom:0.6"></i></a><ul class="sub-nav menus_item_child"><li><a href="/galleries"><i class="fas fa-image" style="margin-top:-20px;zoom:0.6"></i> <span>相册</span></a></li><li><a href="/bibi"><i class="fa-fw fa-solid fa-cloud-rain" style="margin-top:-20px;zoom:0.6"></i> <span>哔哔</span></a></li><li><a href="/todolist"><i class="fa-fw fa-solid fa-circle-check" style="margin-top:-20px;zoom:0.6"></i> <span>清单</span></a></li><li><a href="/musics"><i class="fas fa-music" style="margin-top:-20px;zoom:0.6"></i> <span>音乐</span></a></li></ul></li><li class="hide-on-med-and-down nav-item"><a href="" class="waves-effect waves-light"><i class="fa-solid fa-circle-info" style="zoom:0.6"></i> <span>更多</span><i class="fas fa-chevron-down" aria-hidden="true" style="zoom:0.6"></i></a><ul class="sub-nav menus_item_child"><li><a href="/contact"><i class="fas fa-comments" style="margin-top:-20px;zoom:0.6"></i> <span>留言</span></a></li><li><a href="/friends"><i class="fa-solid fa-link" style="margin-top:-20px;zoom:0.6"></i> <span>友链</span></a></li><li><a href="/friend-circle"><i class="fa-solid fa-rss" style="margin-top:-20px;zoom:0.6"></i> <span>圈圈</span></a></li><li><a href="/about"><i class="fas fa-user-circle" style="margin-top:-20px;zoom:0.6"></i> <span>关于</span></a></li></ul></li><li><a href="#searchModal" class="modal-trigger waves-effect waves-light"><i id="searchIcon" class="fas fa-search" title="搜索" style="zoom:0.85"></i></a></li><li><a href="javascript:;" class="waves-effect waves-light" onclick="switchNightMode()" title="深色/浅色模式"><i id="sum-moon-icon" class="fas fa-sun" style="zoom:0.85"></i></a></li></ul><div id="mobile-nav" class="side-nav sidenav"><div class="mobile-head bg-color"><img src="https://gcore.jsdelivr.net/gh/zyxelva/zyxelva.github.io@main/medias/avatar/avatar2.jpg" class="logo-img circle responsive-img"><div class="logo-name">Kezade</div><div class="logo-desc">7 年 Java 开发经验，其中 3 年以上大型系统架构设计经验，以及 2 年以上的团队管理经验 | 具有分布式、高并发、高可用、大数据量的系统架构设计以及研发经验 | 对 Zookeeper、Netty、Dubbo、Spring Cloud、 Spring 等开源框架源码有过深入研究，并且有一定的框架定制开发经验</div></div><ul class="menu-list mobile-menu-list"><li class="m-nav-item"><a href="/" class="waves-effect waves-light"><i class="fa-fw fas fa-home"></i> 首页</a></li><li class="m-nav-item"><a href="javascript:;"><i class="fa-fw fa-solid fa-newspaper"></i> 文章<span class="m-icon"><i class="fas fa-chevron-right"></i></span></a><ul><li><a href="/tags" style="margin-left:75px"><i class="fa fas fa-tags" style="position:absolute;left:50px"></i> <span>标签</span></a></li><li><a href="/categories" style="margin-left:75px"><i class="fa fas fa-bookmark" style="position:absolute;left:50px"></i> <span>分类</span></a></li><li><a href="/archives" style="margin-left:75px"><i class="fa fas fa-archive" style="position:absolute;left:50px"></i> <span>归档</span></a></li></ul></li><li class="m-nav-item"><a href="javascript:;"><i class="fa-fw fa-solid fa-sitemap"></i> 系列<span class="m-icon"><i class="fas fa-chevron-right"></i></span></a><ul><li><a href="/categories/%E7%AE%97%E6%B3%95" style="margin-left:75px"><i class="fa fa-solid fa-rocket" style="position:absolute;left:50px"></i> <span>算法学习</span></a></li><li><a href="/categories/RocketMQ%E5%AD%A6%E4%B9%A0" style="margin-left:75px"><i class="fa fa-solid fa-rocket" style="position:absolute;left:50px"></i> <span>RMQ学习</span></a></li><li><a href="/categories/Netty%E5%AD%A6%E4%B9%A0" style="margin-left:75px"><i class="fa fa-solid fa-rocket" style="position:absolute;left:50px"></i> <span>Netty学习</span></a></li><li><a href="/categories/Spring%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0" style="margin-left:75px"><i class="fa fa-solid fa-rocket" style="position:absolute;left:50px"></i> <span>Spring学习</span></a></li><li><a href="/categories/JVM%E5%AD%A6%E4%B9%A0" style="margin-left:75px"><i class="fa fa-solid fa-rocket" style="position:absolute;left:50px"></i> <span>JVM学习</span></a></li><li><a href="/categories/MySQL%E5%AD%A6%E4%B9%A0" style="margin-left:75px"><i class="fa fa-solid fa-rocket" style="position:absolute;left:50px"></i> <span>MySQL学习</span></a></li><li><a href="/categories/MyBatis%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0" style="margin-left:75px"><i class="fa fa-solid fa-rocket" style="position:absolute;left:50px"></i> <span>MyBatis学习</span></a></li><li><a href="/categories/Zookeeper%E5%AD%A6%E4%B9%A0" style="margin-left:75px"><i class="fa fa-solid fa-rocket" style="position:absolute;left:50px"></i> <span>ZK学习</span></a></li><li><a href="/categories/Hexo" style="margin-left:75px"><i class="fa fa-solid fa-rocket" style="position:absolute;left:50px"></i> <span>Hexo学习</span></a></li><li><a href="/categories/Redis%E5%AD%A6%E4%B9%A0" style="margin-left:75px"><i class="fa fa-solid fa-rocket" style="position:absolute;left:50px"></i> <span>Redis学习</span></a></li><li><a href="/categories/Docker%E5%AD%A6%E4%B9%A0" style="margin-left:75px"><i class="fa fa-solid fa-rocket" style="position:absolute;left:50px"></i> <span>Docker学习</span></a></li><li><a href="/categories/AP-Calculus" style="margin-left:75px"><i class="fa fa-solid fa-rocket" style="position:absolute;left:50px"></i> <span>AP学习</span></a></li><li><a href="/categories/A-Level" style="margin-left:75px"><i class="fa fa-solid fa-rocket" style="position:absolute;left:50px"></i> <span>A-Level学习</span></a></li><li><a href="/categories/SAT" style="margin-left:75px"><i class="fa fa-solid fa-rocket" style="position:absolute;left:50px"></i> <span>SAT学习</span></a></li><li><a href="/categories/%E8%80%83%E7%A0%94" style="margin-left:75px"><i class="fa fa-solid fa-rocket" style="position:absolute;left:50px"></i> <span>考研</span></a></li><li><a href="/categories/OSSD" style="margin-left:75px"><i class="fa fa-solid fa-rocket" style="position:absolute;left:50px"></i> <span>OSSD</span></a></li><li><a href="/categories/%E9%AB%98%E8%80%83" style="margin-left:75px"><i class="fa fa-solid fa-rocket" style="position:absolute;left:50px"></i> <span>高考</span></a></li></ul></li><li class="m-nav-item"><a href="javascript:;"><i class="fa-fw fa-solid fa-place-of-worship"></i> 我的<span class="m-icon"><i class="fas fa-chevron-right"></i></span></a><ul><li><a href="/galleries" style="margin-left:75px"><i class="fa fas fa-image" style="position:absolute;left:50px"></i> <span>相册</span></a></li><li><a href="/bibi" style="margin-left:75px"><i class="fa fa-fw fa-solid fa-cloud-rain" style="position:absolute;left:50px"></i> <span>哔哔</span></a></li><li><a href="/todolist" style="margin-left:75px"><i class="fa fa-fw fa-solid fa-circle-check" style="position:absolute;left:50px"></i> <span>清单</span></a></li><li><a href="/musics" style="margin-left:75px"><i class="fa fas fa-music" style="position:absolute;left:50px"></i> <span>音乐</span></a></li></ul></li><li class="m-nav-item"><a href="javascript:;"><i class="fa-fw fa-solid fa-circle-info"></i> 更多<span class="m-icon"><i class="fas fa-chevron-right"></i></span></a><ul><li><a href="/contact" style="margin-left:75px"><i class="fa fas fa-comments" style="position:absolute;left:50px"></i> <span>留言</span></a></li><li><a href="/friends" style="margin-left:75px"><i class="fa fa-solid fa-link" style="position:absolute;left:50px"></i> <span>友链</span></a></li><li><a href="/friend-circle" style="margin-left:75px"><i class="fa fa-solid fa-rss" style="position:absolute;left:50px"></i> <span>圈圈</span></a></li><li><a href="/about" style="margin-left:75px"><i class="fa fas fa-user-circle" style="position:absolute;left:50px"></i> <span>关于</span></a></li></ul></li><li><div class="divider"></div></li><li><a href="https://github.com/blinkfox/hexo-theme-matery" class="waves-effect waves-light" target="_blank"><i class="fab fa-github-square fa-fw"></i> Fork Me</a></li></ul></div></div><style>.nav-transparent .github-corner{display:none!important}.github-corner{position:absolute;z-index:10;top:0;right:0;border:0;transform:scale(1.1)}.github-corner svg{color:#0f9d58;fill:#fff;height:64px;width:64px}.github-corner:hover .octo-arm{animation:a .56s ease-in-out}.github-corner .octo-arm{animation:none}@keyframes a{0%,to{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}</style><a href="https://github.com/blinkfox/hexo-theme-matery" class="github-corner tooltipped hide-on-med-and-down" target="_blank" data-tooltip="Fork Me" data-position="left" data-delay="50"><svg viewBox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115 130 115 142 142 250 250 250 0Z"></path><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"></path><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4L133.7 101.6C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8Z" fill="currentColor" class="octo-body"></path></svg></a></nav></header><script src="https://gcore.jsdelivr.net/gh/zyxelva/zyxelva.github.io@main/libs/cryptojs/crypto-js.min.js"></script><script></script><style>:root{--post-bg-image:url('https://gcore.jsdelivr.net/gh/zyxelva/zyxelva.github.io@main/medias/MySQL.jpeg')}</style><div class="bg-cover pd-header post-cover"><div class="container" style="right:0;left:0"><div class="row"><div class="col s12 m12 l12"><div class="brand"><h1 class="description center-align post-title">【MySQL学习】9.锁</h1></div></div></div></div></div><main class="post-container content"><div class="row"><div id="main-content" class="col s12 m12 l9"><div id="artDetail"><div class="card"><div class="card-content article-info"><div class="row tag-cate"><div class="col s7"><div class="article-tag"><a href="/tags/MySQL/"><span class="chip bg-color">MySQL</span></a> <a href="/tags/%E9%94%81/"><span class="chip bg-color">锁</span></a></div></div><div class="col s5 right-align"><div class="post-cate"><i class="fas fa-bookmark fa-fw icon-category"></i> <a href="/categories/MySQL%E5%AD%A6%E4%B9%A0/" class="post-category">MySQL学习</a></div></div></div><div class="post-info"><div class="post-date info-break-policy"><i class="far fa-calendar-minus fa-fw"></i> 发布日期:&nbsp;&nbsp; 2023-06-21</div><div class="info-break-policy"><i class="far fa-file-word fa-fw"></i> 文章字数:&nbsp;&nbsp; 6k</div><div class="info-break-policy"><i class="far fa-clock fa-fw"></i> 阅读时长:&nbsp;&nbsp; 22 分</div></div></div><hr class="clearfix"><link rel="stylesheet" href="https://gcore.jsdelivr.net/gh/zyxelva/zyxelva.github.io@main/libs/prism/prism.min.css"><div class="card-content article-card-content"><div id="articleContent"><h1 id="1-InnoDB中的锁"><a href="#1-InnoDB中的锁" class="headerlink" title="1 InnoDB中的锁"></a>1 InnoDB中的锁</h1><p>在MySQL官方文档中（version 5.7），InnoDB中有以下几种锁：</p><ul><li>Shared and Exclusive Locks：共享（乐观）锁、排他/互斥/独占锁</li><li>Intention Locks：意向锁</li><li>Record Locks：行锁</li><li>Gap Locks：间隙锁</li><li>Next-Key Locks：临键锁</li><li>Insert Intention Locks：插入意向锁</li><li>AUTO-INC Locks：自增锁</li><li>Predicate Locks for Spatial Indexes：空间索引预测锁</li></ul><p>总的来说，可以如下分类：<br><img src="https://gcore.jsdelivr.net/gh/zyxelva/picgo/markdown/Lock-category.png"></p><div class="caption"><b class="center-caption">分类</b></div><p></p><h1 id="2-解决并发事务问题"><a href="#2-解决并发事务问题" class="headerlink" title="2 解决并发事务问题"></a>2 解决并发事务问题</h1><p>并发情况下，一方面，我们要充分利用数据库的并发访问，实现数据能被用户高效的获取；另一方面，又要保证线程或者说用户得到<code>一致性</code>的数据或者<code>安全的修改数据</code>。</p><p>而上一章讲过，一个事务进行<code>读取</code>操作，另一个进行<code>改动</code>操作，这种情况下<strong>可能</strong>发生<code>脏读</code>、<code>不可重复读</code>、<code>幻读</code>的问题。在<code>SQL标准</code>下，规定不同隔离级别下可能发生的问题不一样：</p><div class="table-container"><table><thead><tr><th></th><th>脏读</th><th>幻读</th><th>不可重复读</th></tr></thead><tbody><tr><td><code>READ UNCOMMITTED</code></td><td>可能</td><td>可能</td><td>可能</td></tr><tr><td><code>READ COMMITTED</code></td><td>-</td><td>可能</td><td>可能</td></tr><tr><td><code>REPEATABLE READ</code></td><td>-</td><td>-</td><td>可能</td></tr><tr><td><code>SERIALIZABLE</code></td><td>-</td><td>-</td><td>-</td></tr></tbody></table></div><p>而各个数据库厂商对<code>SQL标准</code>的支持都<code>可能不一样</code>，与 <code>SQL标准</code>不同的一点就是，MySQL 在 <code>REPEATABLE READ</code> 隔离级别实际上就<strong>基本解决</strong>了<code>幻读问题</code>。</p><div class="table-container"><table><thead><tr><th></th><th>脏读</th><th>幻读</th><th>不可重复读</th></tr></thead><tbody><tr><td><code>READ UNCOMMITTED</code></td><td>可能</td><td>可能</td><td>可能</td></tr><tr><td><code>READ COMMITTED</code></td><td>-</td><td>可能</td><td>可能</td></tr><tr><td><code>REPEATABLE READ</code></td><td>-</td><td>-</td><td><font color="red">—-</font></td></tr><tr><td><code>SERIALIZABLE</code></td><td>-</td><td>-</td><td>-</td></tr></tbody></table></div><p>怎么解决脏读、不可重复读、幻读这些问题呢?其实有两种可选的解决方案：</p><h2 id="2-1-方案一：读操作MVCC，写操作加锁"><a href="#2-1-方案一：读操作MVCC，写操作加锁" class="headerlink" title="2.1 方案一：读操作MVCC，写操作加锁"></a>2.1 方案一：读操作MVCC，写操作加锁</h2><blockquote><p>事务利用 <code>MVCC</code> 进行的读取操作称之为<code>一致性读</code>，或者<code>一致性无锁读</code>，也称之为<code>快照读</code>。</p></blockquote><p>上一章节详细介绍了MVCC及其所解决的问题：在<code>快照读</code>的情况下，实现读写不冲突，并能尽量避免<code>幻读</code>情况发生。<br>即：</p><blockquote><p>通过生成一个 <code>ReadView</code>， 然后通过 <code>ReadView</code> 找到符合条件的<code>记录版本</code>(历史版本是由 undo log构建的)， 其实就像是在生成 <code>ReadView</code> 的那个时刻做了一个<code>快照</code>，<code>查询语句</code>只能读到在生成 ReadView 之前已提交事务所做的更改，在生成 ReadView 之前未提交的事务或者之后才开启的事务所做的更改是看不到的。而<code>写操作</code>肯定针对的是<code>最新版本的记录</code>，读记录的历史版本和改动记录的最新版本本身并不冲突，也就是采用 <code>MVCC</code> 时，<code>读-写</code>操作并不冲突。</p></blockquote><p><code>普通的 SELECT 语句</code>在 <code>READ COMMITTED</code> 和 <code>REPEATABLE READ</code> 隔离级别下会使用到 <code>MVCC</code> 读取记录。在 <code>READ COMMITTED</code> 隔离级别下，一个事务在执行过程中<code>每次执行 SELECT 操作</code>时都会生成一个 <code>ReadView</code>，<code>ReadView</code> 的存在本身就<strong>保证</strong>了事务不可以读取到未提交的事务所做的更改，也就是避免了脏读现象；</p><blockquote><p>Tips: 普通的SELECT 语句是指在<code>非串行化事务隔离级别</code>下，<code>不加锁的select语句</code>。</p></blockquote><p>而在<code>REPEATABLE READ</code> 隔离级别下，一个事务在执行过程中只有<code>第一次执行 SELECT 操作</code>才会生成一个 <code>ReadView</code>，之后的 SELECT 操作都<code>复用</code>这个 <code>ReadView</code>， 这样也就避免了<code>不可重复读</code>和很大程度上避免了<code>幻读</code>的问题。</p><blockquote><p>所有<code>普通的SELECT语句</code>（plain SELECT）在<code>READ COMMITTED</code>、<code>REPEATABLE READ</code> 隔离级别下都算是<code>一致性读</code>。</p></blockquote><h2 id="2-2-方案二：读写均采用加锁"><a href="#2-2-方案二：读写均采用加锁" class="headerlink" title="2.2 方案二：读写均采用加锁"></a>2.2 方案二：读写均采用加锁</h2><p>银行的很多业务查询，特别是跟钱直接相关的ATM查询，基本都是加锁查询的，每一步都是。</p><p><code>脏读</code>的产生是因为当前事务读取了另一个<code>未提交事务</code>写的一条记录， 如果另一个事务在写记录的时候就给这条记录<code>加锁</code>，那么当前事务就<code>无法继续读取</code>该记录了，所以也就<code>不会有脏读问题</code>的产生了。</p><p><code>不可重复读</code>的产生是因为当前事务<code>先读取</code>一条记录，另外一个事务对该记录做了<code>改动</code>之后并<code>提交</code>之后，当前事务<code>再次读取</code>时会获得<code>不同的值</code>，如果在当前事务读取记录时就给该记录<code>加锁</code>，那么另一个事务就<code>无法修改</code>该记录，自然也不会发生不可重复读了。</p><h1 id="3-锁定读"><a href="#3-锁定读" class="headerlink" title="3 锁定读"></a>3 锁定读</h1><p><code>MVCC</code>是对应<code>快照读/一致性读</code>，而<code>锁定读</code>是对应加锁情况，指对读取的记录<code>加锁</code>，阻塞其他事务同时改动相同记录，避免出现安全问题，也称<code>当前读</code>。</p><p>哪些情况属于<code>锁定读/当前读</code>？</p><ul><li><code>select lock in share mode</code> (共享锁)</li><li><code>select for update</code> (排他锁)</li><li><code>update</code> (排他锁)</li><li><code>insert</code> (排他锁)</li><li><code>delete</code> (排他锁)</li><li><code>串行化事务隔离级别</code></li></ul><p>这些都是<code>当前读</code>。</p><blockquote><p><code>当前读</code>这种实现方式，也可以称之为 <code>LBCC</code>(基于锁的并发控制，Lock-Based Concurrency Control)。</p></blockquote><h2 id="3-1-Shared-and-Exclusive-Locks（共享锁与排他锁）"><a href="#3-1-Shared-and-Exclusive-Locks（共享锁与排他锁）" class="headerlink" title="3.1 Shared and Exclusive Locks（共享锁与排他锁）"></a>3.1 Shared and Exclusive Locks（共享锁与排他锁）</h2><p>在使用<code>加锁</code>的方式解决问题时，由于既要允许<code>读-读</code>情况不受影响，又要使<code>写-写</code>、<code>读-写</code>或<code>写-读</code>情况中的操作<code>相互阻塞</code>，MySQL 中的锁有好几类：</p><ul><li>共享锁，<code>Shared Locks</code>，简称 <code>S 锁</code>。在事务要读取一条记录时，需要先获取该记录的 <code>S 锁</code>。</li><li>独占锁，也常称<code>排他锁</code>，<code>Exclusive Locks</code>，简称 <code>X 锁</code>。在事务要改动一条记录时，需要先获取该记录的 <code>X 锁</code>。</li></ul><p>比如MySQL中的两类加锁语句：</p><ul><li><p>锁定读下的<code>Select</code>语句：</p><ul><li><p><code>SELECT ... LOCK IN SHARE MODE</code>，这是<code>S锁</code>；</p><blockquote><p>如果当前事务执行了该语句，那么它会为读取到的记录加<code>S 锁</code>，这样<code>允许</code>别的事务继续获取这些记录的<code>S 锁</code>（比方说别的事务也使用<code>SELECT ... LOCK IN SHARE MODE</code> 语句来读取这些记录），但是<strong>不能</strong>获取这些记录的<code>X 锁</code>（比方说使用<code>SELECT ... FOR UPDATE</code>语句来读取这些记录，或者直接<code>修改</code>这些记录）。<br>如果别的事务想要获取这些记录的<code>X锁</code>，那么它们会<code>阻塞</code>，直到当前事务提交之后将这些记录上的<code>S锁</code><strong>释放掉</strong>。</p></blockquote></li><li><p><code>SELECT ... FOR UPDATE</code>：这是<code>X锁</code>。</p><blockquote><p>比如语句<code>SELECT ... FOR UPDATE</code>，如果当前事务执行了该语句，那么它会为读取到的记录加<code>X 锁</code>，这样<code>既不允许</code>别的事务获取这些记录的<code>S锁</code>（比方说别的事务使用<code>SELECT ... LOCK IN SHARE MODE</code> 语句来读取这些记录），<code>也不允许</code>获取这些记录的<code>X 锁</code>（比如说使用<code>SELECT ... FOR UPDATE</code> 语句来读取这些记录，或者<code>直接修改</code>这些记录）。<br>如果别的事务想要获取这些记录的<code>S 锁</code>或者<code>X 锁</code>，那么它们会<code>阻塞</code>，直到当前事务提交之后将这些记录上的<code>X 锁</code><strong>释放掉</strong>。</p></blockquote></li></ul></li><li>写操作语句：<ul><li>Delete语句：对一条记录做 <code>DELETE 操作</code>的过程其实是先在 <code>B+树</code>中定位到这条记录的位置， 然后获取一下这条记录的 <code>X 锁</code>，然后再执行<code>delete mark操作</code>。我们也可以把这个定位待删除记录在 <code>B+树</code>中位置的过程看成是一个获取 <code>X 锁</code>的<code>锁定读</code>。</li><li>Insert语句： 一般情况下，新插入一条记录的操作并不加锁，InnoDB 通过一种称之为<code>隐式锁</code>来保护这条新插入的记录在本事务提交前不被别的事务访问。<blockquote><p>一个事务对新插入的记录可以不显式的加锁，但是别的事务在对这条记录加<code>S 锁</code>或者<code>X 锁</code>时，会去检查索引记录中的<code>trx_id</code> 隐藏列，然后进行各种判断，会先帮助当前事务生成一个<code>锁结构</code>，然后自己再生成一个锁结构后进入<code>等待状态</code>。但是由于<code>事务id</code>的存在，相当于加了一个<code>隐式锁</code>。<br>这样的话，<code>隐式锁</code>就起到了延迟生成锁的用处。这个过程，我们无法干预，是由<code>引擎自动处理</code>的，对我们是完全透明的，我们知道下就行了。</p></blockquote></li><li>Update语句：分为三种情况。<ul><li><code>未修改该记录的键值</code>且<code>被更新的列未发生存储空间的变化</code>，先定位 <code>B+树</code>位置，再获取下该记录的 <code>X 锁</code>，最后在原位置<code>修改</code>；</li><li><code>未修改该记录的键值</code>且<code>至少有一列的存储空间发生变化</code>，则先定位 <code>B+树</code>的位置，再获取该记录的 <code>X 锁</code>，将该记录<code>删除</code>，再<code>插入</code>一条新的记录（<code>insert 的隐式锁</code>）；</li><li><code>修改了该记录的键值</code>，相当于<code>先 delete</code>，<code>再 insert</code>，加锁则按照 <code>delete</code> 和 <code>insert</code> 的规则进行。</li></ul></li></ul></li></ul><h1 id="4-锁的粒度"><a href="#4-锁的粒度" class="headerlink" title="4 锁的粒度"></a>4 锁的粒度</h1><p>我们前边提到的锁都是针对<code>记录</code>的，也可以被称之为<code>行级锁</code>或者<code>行锁</code>，对一 条记录加锁影响的也只是这条记录而已，我们就说这个锁的粒度比较<code>细</code>；</p><p>其实一个事务也可以在<code>表级别</code>进行加锁，自然就被称之为<code>表级锁</code>或者<code>表锁</code>，对一个表加锁影响<code>整个表中的记录</code>，我们就说这个锁的粒度比较<code>粗</code>。给表加的锁也可以分为<code>共享锁</code>(S 锁)和<code>排他锁</code>(X 锁)。</p><h2 id="4-1-表锁与行锁的比较"><a href="#4-1-表锁与行锁的比较" class="headerlink" title="4.1 表锁与行锁的比较"></a>4.1 表锁与行锁的比较</h2><ul><li>锁定粒度：表锁 &gt; 行锁</li><li>加锁效率：表锁 &gt; 行锁</li><li>冲突概率：表锁 &gt; 行锁</li><li>并发性能：表锁 &lt; 行锁</li></ul><blockquote><p>给表加S锁：</p><ul><li>别的事务<code>可以</code>继续获得该表的<code>S锁</code>；</li><li>别的事务<code>可以</code>继续获得该表中的某些记录的<code>S锁</code>；</li><li>别的事务<code>不可以</code>继续获得该表的<code>X锁</code>；</li><li>别的事务<code>不可以</code>继续获得该表中的某些记录的<code>X锁</code>。</li></ul><p>给表加X锁：</p><ul><li>别的事务<code>不可以</code>继续获得该表的<code>S锁</code>；</li><li>别的事务<code>不可以</code>继续获得该表中的某些记录的<code>S锁</code>；</li><li>别的事务<code>不可以</code>继续获得该表的<code>X锁</code>；</li><li>别的事务<code>不可以</code>继续获得该表中的某些记录的<code>X锁</code>。</li></ul></blockquote><h2 id="4-2-表锁之意向锁（Intention-Locks）"><a href="#4-2-表锁之意向锁（Intention-Locks）" class="headerlink" title="4.2 表锁之意向锁（Intention Locks）"></a>4.2 表锁之意向锁（Intention Locks）</h2><ul><li>意向共享锁，<code>Intention Shared Lock</code>，简称 <code>IS 锁</code>。当事务准备在某条记录上加 <code>S 锁</code>时，需要先在<code>表级别</code>加一个 <code>IS 锁</code>。</li><li>意向独占锁，<code>Intention Exclusive Lock</code>，简称 <code>IX 锁</code>。当事务准备在某条记录上加 <code>X 锁</code>时，需要先在<code>表级别</code>加一个 <code>IX 锁</code>。</li></ul><p><code>IS锁</code>、<code>IX锁</code>是<code>表级锁</code>，它们的提出仅仅为了在之后加<code>表级别</code>的 <code>S 锁</code> 和 <code>X 锁</code>时可以快速判断表中的记录<code>是否被上锁</code>，以<strong>避免</strong>用<code>遍历的方式</code>来查看表中<strong>有没有上锁的记录</strong>。</p><p>就是说其实 <code>IS 锁</code>和 <code>IX 锁</code>是<code>兼容的</code>，<code>IX 锁</code>和 <code>IX 锁</code>是<code>兼容的</code>。 我们画个表来看一下<code>表级别</code>的各种<code>锁的兼容性</code>：</p><div class="table-container"><table><thead><tr><th>兼容性</th><th>X</th><th>IX</th><th>S</th><th>IS</th></tr></thead><tbody><tr><td>X</td><td>不兼容</td><td>不兼容</td><td>不兼容</td><td>不兼容</td></tr><tr><td>IX</td><td>不兼容</td><td></td><td>不兼容</td><td></td></tr><tr><td>S</td><td>不兼容</td><td>不兼容</td><td></td><td></td></tr><tr><td>IS</td><td>不兼容</td><td></td><td></td></tr></tbody></table></div><p><code>锁的组合性</code>：</p><div class="table-container"><table><thead><tr><th>兼容性</th><th>X</th><th>IX</th><th>S</th><th>IS</th></tr></thead><tbody><tr><td>表锁</td><td>有</td><td>有</td><td>有</td><td>有</td></tr><tr><td>行锁</td><td>有</td><td></td><td>有</td></tr></tbody></table></div><h1 id="5-MySQL-中的行锁和表锁"><a href="#5-MySQL-中的行锁和表锁" class="headerlink" title="5 MySQL 中的行锁和表锁"></a>5 MySQL 中的行锁和表锁</h1><p>对于 <code>MyISAM</code>、<code>MEMORY</code>、<code>MERGE</code> 这些存储引擎来说，它们<code>只支持表级锁</code>， 而且这些引擎并<code>不支持事务</code>，所以使用这些存储引擎的<code>锁</code>一般都是针对<code>当前会话</code>来说的。</p><p>因为使用 <code>MyISAM</code>、<code>MEMORY</code>、<code>MERGE</code> 这些存储引擎的表在同一时刻只允许<code>一个会话</code>对表进行<code>写操作</code>，所以这些存储引擎实际上最好用在<code>只读</code>，或者大部分都是<code>读操作</code>，或者单用户的情景下。 另外，在 <code>MyISAM</code> 存储引擎中有一个称之为 <code>Concurrent Inserts</code> 的特性，支持在对 <code>MyISAM</code> 表读取时同时插入记录，这样可 以提升一些插入速度。关于更多 <code>Concurrent Inserts</code> 的细节，详情可以参考文档。</p><p>接下来，重点讲讲在<code>InnoDB</code>存储引擎下的一些锁。</p><h2 id="5-1-InnoDB-中的表级锁"><a href="#5-1-InnoDB-中的表级锁" class="headerlink" title="5.1 InnoDB 中的表级锁"></a>5.1 InnoDB 中的表级锁</h2><h3 id="5-1-1-表级别的-S-锁、X-锁"><a href="#5-1-1-表级别的-S-锁、X-锁" class="headerlink" title="5.1.1 表级别的 S 锁、X 锁"></a>5.1.1 表级别的 S 锁、X 锁</h3><p>在对某个表执行 <code>SELECT</code>、<code>INSERT</code>、<code>DELETE</code>、<code>UPDATE</code> 语句时，<code>InnoDB 存储引擎</code>是<strong>不会</strong>为这个表添加<strong>表级别</strong>的 <code>S 锁</code>或者 <code>X 锁</code>的。</p><p>另外，在对某个表执行一些诸如 <code>ALTER TABLE</code>、<code>DROP TABLE</code> 这类的 <code>DDL</code> 语句 时，其他事务对这个表并发执行诸如 <code>SELECT</code>、<code>INSERT</code>、<code>DELETE</code>、<code>UPDATE</code> 的语句会发生<code>阻塞</code>；</p><p>同理，某个事务中对某个表执行 <code>SELECT</code>、<code>INSERT</code>、<code>DELETE</code>、<code>UPDATE</code> 语句时，在其他会话中对这个表执行 <code>DDL</code> 语句也会发生<code>阻塞</code>。这个过程其实是通过在 <code>server 层</code>使用一种称之为<code>元数据锁</code>(Metadata Locks，简称 MDL) 来实现的，一般情况下也不会使用 InnoDB 存储引擎自己提供的表级别的 <code>S 锁</code>和 <code>X锁</code>。</p><blockquote><p>其实这个 <code>InnoDB 存储引擎</code>提供的<code>表级 S 锁</code>或者 <code>X 锁</code>是<strong>相当鸡肋</strong>，只会在一些特殊情况下，比方说<code>崩溃恢复</code>过程中用到。不过我们还是可以<code>手动获取</code>一下的， 比方说在系统变量 <code>autocommit=0</code>，<code>innodb_table_locks = 1</code> 时，手动获取 InnoDB 存储引擎提供的<code>表 t 的 S 锁或者 X 锁</code>可以这么写:</p><ul><li><code>LOCK TABLES t READ</code>：InnoDB 存储引擎会对表 t 加<code>表级别的 S 锁</code>。</li><li><code>LOCK TABLES t WRITE</code>：InnoDB 存储引擎会对表 t 加<code>表级别的 X 锁</code>。</li></ul><p>不过请<code>尽量避免</code>在使用 <code>InnoDB 存储引擎</code>的表上使用 <code>LOCK TABLES</code> 这样的手动锁表语句，它们并不会提供什么额外的保护，只是会<code>降低并发能力</code>而已。</p><h3 id="5-1-2-表级别的-IS-锁、IX-锁"><a href="#5-1-2-表级别的-IS-锁、IX-锁" class="headerlink" title="5.1.2 表级别的 IS 锁、IX 锁"></a>5.1.2 表级别的 IS 锁、IX 锁</h3><p><code>IS 锁</code>和 <code>IX 锁</code>的<strong>使命</strong>：只是为了后续在加<strong>表级别</strong>的 <code>S 锁</code>和 <code>X 锁</code>时判断表中是否有已经<code>被加锁的记录</code>，以<strong>避免</strong>用<code>遍历</code>的方式来查看表中<strong>有没有上锁的记录</strong>。<br>我们并不能手动添加意向锁，只能由 InnoDB 存储引擎自行添加。</p></blockquote><p>当我们在对使用 InnoDB 存储引擎的表的某些记录加 <code>S 锁</code>之前，那就需要先在表级别加一个 <code>IS 锁</code>，当我们在对使用 InnoDB 存储引擎的表的某些记录加 <code>X 锁</code>之前，那就需要先在<strong>表级别</strong>上加一个 <code>IX 锁</code>。</p><h3 id="5-1-3-表级别的-AUTO-INC-锁"><a href="#5-1-3-表级别的-AUTO-INC-锁" class="headerlink" title="5.1.3 表级别的 AUTO-INC 锁"></a>5.1.3 表级别的 AUTO-INC 锁</h3><p>在使用 MySQL 过程中，我们可以为表的<code>某个列</code>添加 <code>AUTO_INCREMENT</code> 属性，之后在插入记录时，可以<code>不指定该列的值</code>，系统会<strong>自动</strong>为它赋上递增的值。</p><p>系统实现这种自动给 <code>AUTO_INCREMENT</code> 修饰的列<strong>递增赋值</strong>的原理主要是两个：</p><ul><li>采用 <code>AUTO-INC 锁</code>，也就是在执行插入语句时就在<strong>表级别</strong>加一个 <code>AUTO-INC 锁</code>，然后为每条待插入记录的 <code>AUTO_INCREMENT</code> 修饰的列分配递增的值，在该语句执行结束后，再把 <code>AUTO-INC 锁</code>释放掉。这样一个事务在持有 <code>AUTO-INC 锁</code>的过程中，其他事务的插入语句都要<code>被阻塞</code>，可以保证一个语句中分配的递增值是<code>连续的</code>。<blockquote><p>如果我们的插入语句在执行前<code>不可以确定</code>具体要插入多少条记录(无法预计即将插入记录的数量)，比方说使用 <code>INSERT ... SELECT</code>、<code>REPLACE ... SELECT</code> 或者<code>LOAD DATA</code>这种插入语句，一般是使用 <code>AUTO-INC 锁</code>为 <code>AUTO_INCREMENT</code> 修饰的列生成对应的值。</p></blockquote></li><li>采用一个<code>轻量级的锁</code>，在为插入语句生成 <code>AUTO_INCREMENT</code> 修饰的列的值时，<strong>获取</strong>一下这个轻量级锁，然后生成本次插入语句需要用到的 <code>AUTO_INCREMENT</code> 列的值之后，就把该轻量级锁<code>释放</code>掉，并不需要等到整个插入语句执行完才释放锁。<blockquote><p>如果我们的插入语句在执行前就可以<code>确定</code>具体要插入多少条记录，比方说我们上边举的关于表 t 的例子中，在语句执行前就可以确定要插入 2 条记录，那么 一般采用轻量级锁的方式对 <code>AUTO_INCREMENT</code> 修饰的列进行赋值。这种方式可以<code>避免锁定表</code>，可以提升插入性能。</p></blockquote></li></ul><p>InnoDB 提供了一个称之为 <code>innodb_autoinc_lock_mode</code> 的系统变量来控制到底使用上述两种方式中的哪种来为 <code>AUTO_INCREMENT</code> 修饰的列进行赋值：</p><ul><li>当 <code>innodb_autoinc_lock_mode = 0</code> 时，一律采用 <code>AUTO-INC 锁</code>；</li><li>当 <code>innodb_autoinc_lock_mode = 2</code> 时，一律采用<code>轻量级锁</code>。这种方式可能会造成不同事务中的<code>插入语句</code>为 <code>AUTO_INCREMENT</code> 修饰的列生成的值是<code>交叉的</code>，在有<code>主从复制</code>的场景中是<code>不安全的</code>。</li><li>当 <code>innodb_autoinc_lock_mode = 1</code> 时，<code>两种方式混着来</code>(也就是在插入记录数量确定时采用轻量级锁，不确定时使用 AUTO-INC 锁)。</li></ul><blockquote><p>MySQL5.7.X 中<code>innodb_autoinc_lock_mode</code>默认值为 1。</p><h2 id="5-2-InnoDB-中的行级锁"><a href="#5-2-InnoDB-中的行级锁" class="headerlink" title="5.2 InnoDB 中的行级锁"></a>5.2 InnoDB 中的行级锁</h2><p><code>行锁</code>，顾名思义就是<strong>在记录上加的锁</strong>。但是要注意，这个<code>记录</code>指的是索引上的<code>索引项</code>。</p><ul><li>只有通过<code>索引条件</code>检索数据，InnoDB 才使用<code>行级锁</code>，否则，InnoDB 将使用<code>表锁</code>；</li><li>不论是使用<code>主键索引</code>、<code>唯一索引</code>或<code>普通索引</code>，InnoDB 都会使用<code>行锁</code>来对数据加锁；</li><li><code>只有执行计划真正使用了索引，才能使用行锁</code>；</li><li>当我们用<code>范围条件</code>而不是相等条件检索数据，并请求锁时，InnoDB 会给<code>符合条件的已有数据记录的索引项加锁</code>。</li></ul></blockquote><h3 id="5-2-1-Record-Locks，记录锁"><a href="#5-2-1-Record-Locks，记录锁" class="headerlink" title="5.2.1 Record Locks，记录锁"></a>5.2.1 Record Locks，记录锁</h3><p>对索引记录项进行加锁。官方的类型名称为: <code>LOCK_REC_NOT_GAP</code>。</p><p>以上一章<a href="/posts/3590034994.html" title="【MySQL学习】8.事务原理与MVCC">【MySQL学习】8.事务原理与MVCC</a> 中的表<code>teacher</code>为例，现插入一条对字段<code>name</code>的索引：<br><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">INDEX</span> <span class="token identifier"><span class="token punctuation">`</span>idx_name<span class="token punctuation">`</span></span><span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>name<span class="token punctuation">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></p><p>目前拥有以下数据：</p><div class="table-container"><table><thead><tr><th>number</th><th>name</th><th>domain</th></tr></thead><tbody><tr><td>1</td><td>Jack</td><td>源码系列</td></tr><tr><td>3</td><td>Mark</td><td>并发编程</td></tr><tr><td>9</td><td>James</td><td>Redis</td></tr><tr><td>15</td><td>King</td><td>JVM</td></tr><tr><td>21</td><td>Dafei</td><td>MySQL</td></tr></tbody></table></div><p>现对<code>name=9</code>的记录加一个<code>记录锁</code>：<br><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> name <span class="token keyword">FROM</span> teacher t <span class="token keyword">WHERE</span> name <span class="token operator">=</span> <span class="token string">'James'</span> <span class="token keyword">FOR</span> <span class="token keyword">UPDATE</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><br>示意图如下：<br><img src="https://gcore.jsdelivr.net/gh/zyxelva/picgo/markdown/record-lock.png"></p><div class="caption"><b class="center-caption">记录锁情况,</b></div><br>则其他事务对<code>teacher</code>表中的<code>name=&#39;James</code>的项进行<code>select</code>、<code>insert</code>、<code>delete</code>都将会被阻塞。<p></p><blockquote><p><code>记录锁</code>是有 <code>S 锁</code>和 <code>X 锁</code>之分：<br>当一个事务获取了一条记录的 <code>S 型</code>记录锁后， 其他事务也可以继续获取该记录的 <code>S 型</code>记录锁，但<strong>不可以</strong>继续获取 <code>X 型</code>记录锁；<br>当一个事务获取了一条记录的 <code>X 型</code>记录锁后，其他事务<strong>既不可以</strong>继续获取该记录的 <code>S 型</code>记录锁，<strong>也不可以</strong>继续获取 <code>X 型</code>记录锁。</p><h3 id="5-2-2-Gap-Locks，间隙锁"><a href="#5-2-2-Gap-Locks，间隙锁" class="headerlink" title="5.2.2 Gap Locks，间隙锁"></a>5.2.2 Gap Locks，间隙锁</h3><p>我们说 MySQL 在 <code>REPEATABLE READ</code> 隔离级别下是可以解决<code>幻读</code>问题的，解决方案有两种，可以使用 <code>MVCC 方案</code>解决，也可以采用<code>加锁方案</code>解决。但是在使用<code>加锁方案</code>解决时有问题，就是事务在第一次执行读取操作时，那些<code>幻影记录</code>尚<code>不存在</code>，我们<strong>无法</strong>给这些<code>幻影记录</code>加上记录锁。InnoDB 提出了一种称之为 <code>Gap Locks</code> 的锁（LOCK_GAP），我们也可以简称为 <code>gap 锁</code>。</p></blockquote><p>默认开启，可通过以下两种方式关闭：</p><ul><li>将事务隔离级别调整为<code>READ COMMITTED</code>；</li><li>或者将<code>innodb_locks_unsafe_for_binlog</code>置为<code>1</code>。<h4 id="5-2-2-1-间隙锁实质上是对索引前后的间隙上锁，不对索引本身上锁（开区间）。"><a href="#5-2-2-1-间隙锁实质上是对索引前后的间隙上锁，不对索引本身上锁（开区间）。" class="headerlink" title="5.2.2.1 间隙锁实质上是对索引前后的间隙上锁，不对索引本身上锁（开区间）。"></a>5.2.2.1 间隙锁实质上是对<code>索引前后的间隙</code>上锁，不对<code>索引本身</code>上锁（开区间）。</h4></li></ul><p>比如：对表<code>teacher</code>插入一条如下的记录(事务id：108210）：<br><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">update</span> teacher <span class="token keyword">set</span> domain <span class="token operator">=</span><span class="token string">'Spring'</span> <span class="token keyword">where</span> name<span class="token operator">=</span><span class="token string">'James'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><br>其会对([‘Jack’,1], [‘James’,9])之间, ([‘James’,9], [‘King’,15])之间进行上锁。<br>ps: 本机MySQL版本：v5.7.17</p><img src="https://gcore.jsdelivr.net/gh/zyxelva/picgo/markdown/gap-lock.png"><div class="caption"><b class="center-caption">间隙锁情况,</b></div><p>现另一事务开启以下插入操作(事务id：108212）：<br><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">begin</span><span class="token punctuation">;</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> teacher <span class="token keyword">value</span><span class="token punctuation">(</span><span class="token number">22</span><span class="token punctuation">,</span><span class="token string">'Jahes'</span><span class="token punctuation">,</span><span class="token string">'docker'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></p><p>结果爆出以下错误：<br><pre class="line-numbers language-none"><code class="language-none">1205 - Lock wait timeout exceeded; try restarting transaction, Time: 51.093000s<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></p><p>通过以下命令可以查看两条事务对表加了什么锁：<br><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">mysql<span class="token operator">></span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> information_schema<span class="token punctuation">.</span>innodb_locks\G<span class="token punctuation">;</span>
<span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span> <span class="token number">1.</span> <span class="token keyword">row</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span>
lock_id: <span class="token number">108212</span>:<span class="token number">1309</span>:<span class="token number">4</span>:<span class="token number">4</span>
lock_trx_id: <span class="token number">108212</span>
lock_mode: X<span class="token punctuation">,</span>GAP
lock_type: RECORD
lock_table: <span class="token identifier"><span class="token punctuation">`</span>student<span class="token punctuation">`</span></span><span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>teacher<span class="token punctuation">`</span></span>
lock_index: idx_name
lock_space: <span class="token number">1309</span>
lock_page: <span class="token number">4</span>
lock_rec: <span class="token number">4</span>
lock_data: <span class="token string">'James'</span><span class="token punctuation">,</span> <span class="token number">9</span>
<span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span> <span class="token number">2.</span> <span class="token keyword">row</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span>
lock_id: <span class="token number">108210</span>:<span class="token number">1309</span>:<span class="token number">4</span>:<span class="token number">4</span>
lock_trx_id: <span class="token number">108210</span>
lock_mode: X
lock_type: RECORD
lock_table: <span class="token identifier"><span class="token punctuation">`</span>student<span class="token punctuation">`</span></span><span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>teacher<span class="token punctuation">`</span></span>
lock_index: idx_name
lock_space: <span class="token number">1309</span>
lock_page: <span class="token number">4</span>
lock_rec: <span class="token number">4</span>
lock_data: <span class="token string">'James'</span><span class="token punctuation">,</span> <span class="token number">9</span>
<span class="token number">2</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span><span class="token punctuation">,</span> <span class="token number">1</span> warning <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></p><p>可以看出：</p><ul><li>事务<code>id=108210</code>是更新操作，通过字段<code>lock_type: RECORD</code>可以得出其对记录<code>name=James</code>所加的锁类型为<code>行锁</code>(注意，这里不是<code>记录锁</code>的意思)；而通过字段<code>lock_mode: X</code>得出这个<code>行锁</code>还是<code>next-key lock</code>。</li><li>事务<code>id=108212</code>是插入操作，<code>lock_type: RECORD</code>得出是对记录<code>name=James</code>加的是<code>行锁</code>，<code>lock_mode: X,GAP</code>得出该<code>行锁</code>为<code>间隙锁</code>。</li></ul><blockquote><p>Tips:</p><ul><li>如果<code>LOCK_MODE</code>为<code>X</code>，说明是 <code>next-key 锁</code>；</li><li>如果<code>LOCK_MODE</code>为<code>X, REC_NOT_GAP</code>，说明是<code>记录锁</code>；</li><li>如果<code>LOCK_MODE</code>为<code>X, GAP</code>，说明是<code>间隙锁</code>。</li></ul></blockquote><h4 id="5-2-2-2-两个事务的间隙锁之间是相互兼容的，不会产生冲突"><a href="#5-2-2-2-两个事务的间隙锁之间是相互兼容的，不会产生冲突" class="headerlink" title="5.2.2.2 两个事务的间隙锁之间是相互兼容的，不会产生冲突"></a>5.2.2.2 两个事务的间隙锁之间是相互兼容的，不会产生冲突</h4><p>间隙锁虽然存在 X 型间隙锁和 S 型间隙锁，但是并没有什么区别，<code>间隙锁之间是兼容的</code>，即两个事务可以同时持有包含共同间隙范围的间隙锁，并不存在互斥关系，因为间隙锁的<code>目的</code>是<strong>防止插入幻读记录而提出的</strong>。</p><h3 id="5-2-3-Next-Key-Locks"><a href="#5-2-3-Next-Key-Locks" class="headerlink" title="5.2.3 Next-Key Locks"></a>5.2.3 Next-Key Locks</h3><p>官方名<code>LOCK_ORDINARY</code>，一个<code>记录锁</code>和一个<code>gap 锁</code>的合体(<strong>左开右闭区间</strong>)。</p><p>默认情况下，InnoDB 以 <code>REPEATABLE READ</code> 隔离级别运行。在这种情况下， InnoDB 使用 <code>Next-Key Locks</code> 锁进行搜索和索引扫描，这可以<code>防止幻读的发生</code>。</p><h3 id="5-2-4-Insert-Intention-Locks，插入意向锁"><a href="#5-2-4-Insert-Intention-Locks，插入意向锁" class="headerlink" title="5.2.4 Insert Intention Locks，插入意向锁"></a>5.2.4 Insert Intention Locks，插入意向锁</h3><p><code>插入意向锁</code>是一种<code>锁的的等待队列</code>，让等锁的事务在内存中进行排队等待，当持有锁的事务完成后，处于等待状态的事务就可以获得锁继续事务了。</p><p>并不是意向锁，它属于<code>行级锁</code>，是一种特殊的<code>间隙锁</code>。</p><p>举例：<br>事务A执行：<br><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">BEGIN</span><span class="token punctuation">;</span>
<span class="token keyword">SELECT</span> name <span class="token keyword">from</span> teacher <span class="token keyword">where</span> name <span class="token operator">BETWEEN</span> <span class="token string">'Jack'</span> <span class="token operator">and</span> <span class="token string">'James'</span> <span class="token keyword">for</span> <span class="token keyword">UPDATE</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></p><p>事务B执行：<br><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">BEGIN</span><span class="token punctuation">;</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> teacher <span class="token keyword">value</span> <span class="token punctuation">(</span><span class="token number">24</span><span class="token punctuation">,</span> <span class="token string">'Jae2'</span><span class="token punctuation">,</span> <span class="token string">'Go'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></p><p>结果：<br><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token number">1205</span> <span class="token operator">-</span> <span class="token keyword">Lock</span> wait timeout exceeded<span class="token punctuation">;</span> try restarting <span class="token keyword">transaction</span><span class="token punctuation">,</span> <span class="token keyword">Time</span>: <span class="token number">51.134000</span>s<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></p><p>通过以下命令输出<code>innodb监控</code>可以查看到<code>插入意向锁</code>的信息：<br><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">show</span> <span class="token keyword">engine</span> <span class="token keyword">innodb</span> <span class="token keyword">status</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></p><p>结果：<br><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">insert</span> <span class="token keyword">into</span> teacher <span class="token keyword">value</span> <span class="token punctuation">(</span><span class="token number">24</span><span class="token punctuation">,</span> <span class="token string">'Jae2'</span><span class="token punctuation">,</span> <span class="token string">'Go'</span><span class="token punctuation">)</span>
<span class="token comment">------- TRX HAS BEEN WAITING 24 SEC FOR THIS LOCK TO BE GRANTED:</span>
RECORD LOCKS space id <span class="token number">1309</span> page <span class="token keyword">no</span> <span class="token number">4</span> n bits <span class="token number">80</span> <span class="token keyword">index</span> idx_name <span class="token keyword">of</span> <span class="token keyword">table</span> <span class="token identifier"><span class="token punctuation">`</span>student<span class="token punctuation">`</span></span><span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>teacher<span class="token punctuation">`</span></span> trx id <span class="token number">108264</span> lock_mode X locks gap（间隙锁） before rec <span class="token keyword">insert</span> intention（插入意向） waiting
Record <span class="token keyword">lock</span><span class="token punctuation">,</span> heap <span class="token keyword">no</span> <span class="token number">4</span> PHYSICAL RECORD: n_fields <span class="token number">2</span><span class="token punctuation">;</span> compact format<span class="token punctuation">;</span> info bits <span class="token number">0</span>
 <span class="token number">0</span>: len <span class="token number">5</span><span class="token punctuation">;</span> hex <span class="token number">4</span>a616d6573<span class="token punctuation">;</span> <span class="token keyword">asc</span> James<span class="token punctuation">;</span><span class="token punctuation">;</span>
 <span class="token number">1</span>: len <span class="token number">4</span><span class="token punctuation">;</span> hex <span class="token number">80000009</span><span class="token punctuation">;</span> <span class="token keyword">asc</span>     <span class="token punctuation">;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></p><p><strong>与间隙锁的区别</strong>：</p><ul><li>是一种<code>特殊的间隙锁</code>，但不同于间隙锁的是，该锁只用于<code>并发插入操作</code>。</li><li>尽管「插入意向锁」也属于间隙锁，但两个事务却<strong>不能在同一时间内，一个拥有间隙锁，另一个拥有该间隙区间内的插入意向锁</strong>（当然，插入意向锁如果不在间隙锁区间内则是可以的）。所以，插入意向锁和间隙锁之间是<code>冲突的</code>。</li></ul><p>生成时机：每插入一条新记录，都需要看一下待插入记录的下一条记录上是否已经被加了<code>间隙锁</code>，如果已加间隙锁，那 <code>Insert</code> 语句会被阻塞，并生成一个<code>插入意向锁</code>。</p><h3 id="5-2-5-隐式锁"><a href="#5-2-5-隐式锁" class="headerlink" title="5.2.5 隐式锁"></a>5.2.5 隐式锁</h3><p>无法干预，是由引擎自动处理的。</p><h3 id="5-2-6-兼容矩阵"><a href="#5-2-6-兼容矩阵" class="headerlink" title="5.2.6 兼容矩阵"></a>5.2.6 兼容矩阵</h3><p>锁模式兼容矩阵（横向是已持有锁，纵向是正在请求的锁）：</p><div class="table-container"><table><thead><tr><th>兼容性</th><th>Gap</th><th>Insert Intention</th><th>Record</th><th>Next-Key</th></tr></thead><tbody><tr><td>Gap</td><td>兼容</td><td>冲突</td><td>兼容</td><td>兼容</td></tr><tr><td>Insert Intention</td><td>兼容</td><td>兼容</td><td>兼容</td><td>兼容</td></tr><tr><td>Record</td><td>兼容</td><td>兼容</td><td>冲突</td><td>冲突</td></tr><tr><td>Next-Key</td><td>兼容</td><td>兼容</td><td>冲突</td><td>冲突</td></tr></tbody></table></div></div><hr><div class="reprint" id="reprint-statement"><div class="reprint__author"><span class="reprint-meta" style="font-weight:700"><i class="fas fa-user">文章作者:</i></span> <span class="reprint-info"><a href="/about" rel="external nofollow noreferrer">Kezade</a></span></div><div class="reprint__type"><span class="reprint-meta" style="font-weight:700"><i class="fas fa-link">文章链接:</i></span> <span class="reprint-info"><a href="https://zyxelva.github.io/posts/1095286017.html">https://zyxelva.github.io/posts/1095286017.html</a></span></div><div class="reprint__notice"><span class="reprint-meta" style="font-weight:700"><i class="fas fa-copyright">版权声明:</i></span> <span class="reprint-info">本博客所有文章除特別声明外，均采用 <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a> 许可协议。转载请注明来源 <a href="/about" target="_blank">Kezade</a> !</span></div></div><script async defer>function navToReprintStatement(){$("html, body").animate({scrollTop:$("#reprint-statement").offset().top-80},800)}document.addEventListener("copy",function(t){M.toast({html:'<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>'})})</script><div class="tag_share" style="display:block"><div class="post-meta__tag-list" style="display:inline-block"><div class="article-tag"><a href="/tags/MySQL/"><span class="chip bg-color">MySQL</span></a> <a href="/tags/%E9%94%81/"><span class="chip bg-color">锁</span></a></div></div><div class="post_share" style="zoom:80%;width:fit-content;display:inline-block;float:right;margin:-.15rem 0"><link rel="stylesheet" href="https://gcore.jsdelivr.net/gh/zyxelva/zyxelva.github.io@main/libs/share/css/share.min.css"><div id="article-share"><div class="social-share" data-sites="google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div><script src="https://gcore.jsdelivr.net/gh/zyxelva/zyxelva.github.io@main/libs/share/js/social-share.min.js"></script></div></div></div><div id="reward"><a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">赏</a><div id="rewardModal" class="modal"><div class="modal-content"><a class="close modal-close"><i class="fas fa-times"></i></a><h4 class="reward-title">你的赏识是我前进的动力</h4><div class="reward-content"><div class="reward-tabs"><ul class="tabs row"><li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li><li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li></ul><div id="alipay"><img src="https://gcore.jsdelivr.net/gh/zyxelva/zyxelva.github.io@main/medias/reward/alipay.jpg" class="reward-img" alt="支付宝打赏二维码"></div><div id="wechat"><img src="https://gcore.jsdelivr.net/gh/zyxelva/zyxelva.github.io@main/medias/reward/wechat.png" class="reward-img" alt="微信打赏二维码"></div></div></div></div></div></div><script>$(function(){$(".tabs").tabs()})</script></div></div><style>.twikoo-card{margin:1.5rem auto}.twikoo-card .card-content{padding:20px}#tcomments textarea{box-sizing:border-box;background:url("/") 100% 100% no-repeat}#tcomments p{margin:2px 2px 10px;font-size:1.05rem;line-height:1.78rem;text-align:left}#tcomments blockquote p{text-indent:.2rem}#tcomments a{padding:0 2px;color:#4cbf30;font-weight:500;text-decoration:none}#tcomments img{max-width:100%;height:auto;cursor:pointer}#tcomments ol li{list-style-type:decimal}#tcomments ol,ul{display:block;padding-left:2em;word-spacing:0.05rem}#tcomments ul li,ol li{display:list-item;line-height:1.8rem;font-size:1rem}#tcomments ul li{list-style-type:disc}#tcomments ul ul li{list-style-type:circle}#tcomments table,td,th{padding:12px 13px;border:1px solid #dfe2e5}#tcomments table,td,th{border:0}table tr:nth-child(2n),thead{background-color:#fafafa}#tcomments table th{background-color:#f2f2f2;min-width:80px}#tcomments table td{min-width:80px}#tcomments h1{font-size:1.85rem;font-weight:700;line-height:2.2rem}#tcomments h2{font-size:1.65rem;font-weight:700;line-height:1.9rem}#tcomments h3{font-size:1.45rem;font-weight:700;line-height:1.7rem}#tcomments h4{font-size:1.25rem;font-weight:700;line-height:1.5rem}#tcomments h5{font-size:1.1rem;font-weight:700;line-height:1.4rem}#tcomments h6{font-size:1rem;line-height:1.3rem}#tcomments p{font-size:1rem;line-height:1.5rem}#tcomments hr{margin:12px 0;border:0;border-top:1px solid #ccc}#tcomments blockquote{margin:15px 0;border-left:5px solid #42b983;padding:1rem .8rem .3rem .8rem;color:#666;background-color:rgba(66,185,131,.1)}#tcomments pre{font-family:monospace,monospace;padding:1.2em;margin:.5em 0;background:#272822;overflow:auto;border-radius:.3em;tab-size:4}#tcomments code{font-family:monospace,monospace;padding:1px 3px;font-size:.92rem;color:#e96900;background-color:#f8f8f8;border-radius:2px}#tcomments pre code{font-family:monospace,monospace;padding:0;color:#e8eaf6;background-color:#272822}#tcomments pre[class*=language-]{padding:1.2em;margin:.5em 0}#tcomments code[class*=language-],pre[class*=language-]{color:#e8eaf6}#tcomments [type=checkbox]:not(:checked),[type=checkbox]:checked{position:inherit;margin-left:-1.3rem;margin-right:.4rem;margin-top:-1px;vertical-align:middle;left:unset;visibility:visible}#tcomments b,strong{font-weight:700}#tcomments dfn{font-style:italic}#tcomments small{font-size:85%}#tcomments cite{font-style:normal}#tcomments mark{background-color:#fcf8e3;padding:.2em}#tcomments table,td,th{padding:12px 13px;border:1px solid #dfe2e5}table tr:nth-child(2n),thead{background-color:#fafafa}#tcomments table th{background-color:#f2f2f2;min-width:80px}#tcomments table td{min-width:80px}#tcomments [type=checkbox]:not(:checked),[type=checkbox]:checked{position:inherit;margin-left:-1.3rem;margin-right:.4rem;margin-top:-1px;vertical-align:middle;left:unset;visibility:visible}</style><div class="card twikoo-card" data-aos="fade-up"><div class="comment_headling" style="font-size:20px;font-weight:700;position:relative;padding-left:20px;top:15px;padding-bottom:5px"><i class="fas fa-comments fa-fw" aria-hidden="true"></i> <span>评论</span></div><div class="card-content" style="display:grid"><div id="tcomments"></div></div></div><script src="https://gcore.jsdelivr.net/npm/twikoo/dist/twikoo.all.min.js"></script><script>twikoo.init({envId:"https://kezadetwikoo.netlify.app/.netlify/functions/twikoo",el:"#tcomments",region:"",path:""}).then(function(){for(var t=document.querySelector("#twikoo").getElementsByTagName("input"),e=0;e<t.length;e++)t[e]&&t[e].classList.add("browser-default")})</script><article id="prenext-posts" class="prev-next articles"><div class="row article-row"><div class="article col s12 m6" data-aos="fade-up"><div class="article-badge left-badge text-color"><i class="fas fa-chevron-left"></i> &nbsp;上一篇</div><div class="card"><a href="/posts/4244691383.html"><div class="card-image"><img src="/medias/JVM.png" class="responsive-img" alt="【JVM学习】1.JVM基础知识"> <span class="card-title">【JVM学习】1.JVM基础知识</span></div></a><div class="card-content article-content"><div class="summary block-with-text"></div><div class="publish-info"><span class="publish-date"><i class="far fa-clock fa-fw icon-date"></i> 2023-06-26</span><span class="publish-author"><i class="fas fa-bookmark fa-fw icon-category"></i> <a href="/categories/JVM%E5%AD%A6%E4%B9%A0/" class="post-category">JVM学习</a></span></div></div><div class="card-action article-tags"><a href="/tags/JVM/"><span class="chip bg-color">JVM</span></a></div></div></div><div class="article col s12 m6" data-aos="fade-up"><div class="article-badge right-badge text-color">下一篇&nbsp;<i class="fas fa-chevron-right"></i></div><div class="card"><a href="/posts/2971760749.html"><div class="card-image"><img src="/medias/hexo.png" class="responsive-img" alt="【Hexo】由CDN引发的暴躁场面"> <span class="card-title">【Hexo】由CDN引发的暴躁场面</span></div></a><div class="card-content article-content"><div class="summary block-with-text"></div><div class="publish-info"><span class="publish-date"><i class="far fa-clock fa-fw icon-date"></i> 2023-06-20</span><span class="publish-author"><i class="fas fa-bookmark fa-fw icon-category"></i> <a href="/categories/Hexo/" class="post-category">Hexo</a></span></div></div><div class="card-action article-tags"><a href="/tags/Hexo%E5%8D%9A%E5%AE%A2/"><span class="chip bg-color">Hexo博客</span></a> <a href="/tags/Hexo%E6%B3%A8%E5%85%A5%E5%99%A8/"><span class="chip bg-color">Hexo注入器</span></a></div></div></div></div></article></div><script>$("#articleContent").on("copy",function(e){if(void 0!==window.getSelection){var n=window.getSelection();if(!((""+n).length<Number.parseInt("120"))){var t=document.getElementsByTagName("body")[0],o=document.createElement("div");o.style.position="absolute",o.style.left="-99999px",t.appendChild(o),o.appendChild(n.getRangeAt(0).cloneContents()),"PRE"!==n.getRangeAt(0).commonAncestorContainer.nodeName&&"CODE"!==n.getRangeAt(0).commonAncestorContainer.nodeName||(o.innerHTML="<pre>"+o.innerHTML+"</pre>");var i=document.location.href;o.innerHTML+='<br />来源: Kezade<br />文章作者: Kezade<br />文章链接: <a href="'+i+'">'+i+"</a><br />本文章著作权归作者所有，任何形式的转载都请注明出处。",n.selectAllChildren(o),window.setTimeout(function(){t.removeChild(o)},200)}}})</script><script src="https://gcore.jsdelivr.net/gh/zyxelva/zyxelva.github.io@main/libs/codeBlock/codeBlockFuction.js"></script><script src="https://gcore.jsdelivr.net/gh/zyxelva/zyxelva.github.io@main/libs/prism/prism.min.js"></script><script src="https://gcore.jsdelivr.net/gh/zyxelva/zyxelva.github.io@main/libs/codeBlock/codeLang.js"></script><script src="https://gcore.jsdelivr.net/gh/zyxelva/zyxelva.github.io@main/libs/codeBlock/codeCopy.js"></script><script src="https://gcore.jsdelivr.net/gh/zyxelva/zyxelva.github.io@main/libs/codeBlock/codeShrink.js"></script></div><div id="toc-aside" class="expanded col l3 hide-on-med-and-down"><div class="toc-widget card" style="background-color:#fff"><div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div><div id="toc-content"></div></div></div></div><div id="floating-toc-btn" class="hide-on-med-and-down"><a class="btn-floating btn-large bg-color"><i class="fas fa-list-ul"></i></a></div><script src="https://gcore.jsdelivr.net/gh/zyxelva/zyxelva.github.io@main/libs/tocbot/tocbot.min.js"></script><script>$(function(){tocbot.init({tocSelector:"#toc-content",contentSelector:"#articleContent",headingsOffset:-(.4*$(window).height()-45),collapseDepth:Number("0"),headingSelector:"h1, h2, h3, h4, h5"});let t=parseInt(.4*$(window).height()-64),e=$(".toc-widget");$(window).scroll(function(){$(window).scrollTop()>t?e.addClass("toc-fixed"):e.removeClass("toc-fixed")});const o="expanded";let n=$("#toc-aside"),i=$("#main-content");$("#floating-toc-btn .btn-floating").click(function(){n.hasClass(o)?(n.removeClass(o).hide(),i.removeClass("l9")):(n.addClass(o).show(),i.addClass("l9")),function(t,e){let o=$("#"+t);if(0===o.length)return;let n=o.width();n+=n>=450?21:n>=350&&n<450?18:n>=300&&n<350?16:14,$("#"+e).width(n)}("artDetail","prenext-posts")})})</script></main><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><script>MathJax.Hub.Config({tex2jax:{inlineMath:[["$","$"],["\\(","\\)"]]}})</script><footer class="page-footer bg-color"><div class="container row center-align" style="margin-bottom:15px!important"><div class="col s12 m8 l8 copy-right">Copyright&nbsp;&copy; <span id="year">2019-2025</span> <a href="/about" target="_blank">Kezade</a> |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a> |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a><br><br><span id="sitetime">Loading ...</span><script>var calcSiteTime=function(){var e=6e4,t=36e5,n=864e5,a=365*n,i=new Date,r="2019",o=i.getFullYear(),s=i.getMonth()+1,l=i.getDate(),m=i.getHours(),c=i.getMinutes(),d=i.getSeconds(),g=Date.UTC(r,"6","28","0","0","0"),h=Date.UTC(o,s,l,m,c,d)-g,u=Math.floor(h/a),M=Math.floor(h/n-365*u),T=Math.floor((h-(365*u+M)*n)/t),f=Math.floor((h-(365*u+M)*n-T*t)/e),y=Math.floor((h-(365*u+M)*n-T*t-f*e)/1e3);if(r===String(o)){document.getElementById("year").innerHTML=o;var v="This site has been running for "+M+" days";v="本站已运行 "+M+" 天",document.getElementById("sitetime").innerHTML=v}else{document.getElementById("year").innerHTML=r+" - "+o;var H="This site has been running for "+u+" years and "+M+" days "+T+" hours "+f+" mins "+y+" seconds";H="本站已苟且偷生 "+u+" 年 "+M+" 天 "+T+" 小时 "+f+" 分钟 "+y+" 秒",document.getElementById("sitetime").innerHTML=H}};calcSiteTime(),setInterval(calcSiteTime,1e3)</script><br></div><div class="col s12 m4 l4 social-link"><a href="https://github.com/zyxelva" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50"><i class="fab fa-github"></i></a><a href="mailto:zyxelva@gmail.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50"><i class="fas fa-envelope-open"></i></a><a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=1807401971" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 1807401971" data-position="top" data-delay="50"><i class="fab fa-qq"></i></a> <a href="https://www.zhihu.com/people/kezade" class="tooltipped" target="_blank" data-tooltip="关注我的知乎: https://www.zhihu.com/people/kezade" data-position="top" data-delay="50"><i class="fab fa-zhihu1">知</i></a><a href="../rss2.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50"><i class="fas fa-rss"></i></a></div></div></footer><div class="progress-bar"></div><div id="searchModal" class="modal"><div class="modal-content"><div class="search-header"><span class="title"><i class="fas fa-search"></i> &nbsp;&nbsp;搜索</span> <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字" class="search-input"></div><div id="searchResult"></div></div></div><script>$(function(){!function(t,e,r){"use strict";$.ajax({url:t,dataType:"xml",success:function(t){var n=$("entry",t).map(function(){return{title:$("title",this).text(),content:$("content",this).text(),url:$("url",this).text()}}).get(),a=document.getElementById(e),s=document.getElementById(r);a.addEventListener("input",function(){var t='<ul class="search-result-list">',e=this.value.trim().toLowerCase().split(/[\s\-]+/);s.innerHTML="",this.value.trim().length<=0||(n.forEach(function(r){var n=!0,a=r.title.trim().toLowerCase(),s=r.content.trim().replace(/<[^>]+>/g,"").toLowerCase(),i=r.url;i=0===i.indexOf("/")?r.url:"/"+i;var l=-1,c=-1,u=-1;if(""!==a&&""!==s&&e.forEach(function(t,e){l=a.indexOf(t),c=s.indexOf(t),l<0&&c<0?n=!1:(c<0&&(c=0),0===e&&(u=c))}),n){t+="<li><a href='"+i+"' class='search-result-title'>"+a+"</a>";var o=r.content.trim().replace(/<[^>]+>/g,"");if(u>=0){var h=u-20,f=u+80;h<0&&(h=0),0===h&&(f=100),f>o.length&&(f=o.length);var m=o.substr(h,f);e.forEach(function(t){var e=new RegExp(t,"gi");m=m.replace(e,'<em class="search-keyword">'+t+"</em>")}),t+='<p class="search-result">'+m+"...</p>"}t+="</li>"}}),t+="</ul>",s.innerHTML=t)})}})}("/search.xml","searchInput","searchResult")})</script><div class="stars-con"><div id="stars"></div><div id="stars2"></div><div id="stars3"></div></div><script>function switchNightMode(){$('<div class="Cuteen_DarkSky"><div class="Cuteen_DarkPlanet"></div></div>').appendTo($("body")),setTimeout(function(){$("body").hasClass("DarkMode")?($("body").removeClass("DarkMode"),localStorage.setItem("isDark","0"),$("#sum-moon-icon").removeClass("fa-sun").addClass("fa-moon")):($("body").addClass("DarkMode"),localStorage.setItem("isDark","1"),$("#sum-moon-icon").addClass("fa-sun").removeClass("fa-moon")),setTimeout(function(){$(".Cuteen_DarkSky").fadeOut(1e3,function(){$(this).remove()})},2e3)})}</script><div id="backTop" class="top-scroll"><a class="btn-floating btn-large waves-effect waves-light" href="#!"><i class="fas fa-arrow-up"></i></a></div><script src="https://gcore.jsdelivr.net/gh/zyxelva/zyxelva.github.io@main/libs/materialize/materialize.min.js"></script><script src="https://gcore.jsdelivr.net/gh/zyxelva/zyxelva.github.io@main/libs/masonry/masonry.pkgd.min.js"></script><script src="https://gcore.jsdelivr.net/gh/zyxelva/zyxelva.github.io@main/libs/aos/aos.js"></script><script src="https://gcore.jsdelivr.net/gh/zyxelva/zyxelva.github.io@main/libs/scrollprogress/scrollProgress.min.js"></script><script src="https://gcore.jsdelivr.net/gh/zyxelva/zyxelva.github.io@main/libs/lightGallery/js/lightgallery-all.min.js"></script><script src="https://gcore.jsdelivr.net/gh/zyxelva/zyxelva.github.io@main/js/matery.js"></script><link rel="stylesheet" href="https://gcore.jsdelivr.net/gh/zyxelva/zyxelva.github.io@main/libs/mermaid/mermaid.min.css"><script src="https://gcore.jsdelivr.net/gh/zyxelva/zyxelva.github.io@main/libs/mermaid/mermaid.min.js"></script><script>window.mermaid&&mermaid.initialize({theme:"forest"})</script><script>!function(){var t=document.createElement("script"),e=window.location.protocol.split(":")[0];t.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(t,s)}()</script><script src="https://gcore.jsdelivr.net/gh/zyxelva/zyxelva.github.io@main/libs/background/ribbon-dynamic.js" async></script><script src="https://gcore.jsdelivr.net/gh/zyxelva/zyxelva.github.io@main/libs/instantpage/instantpage.js" type="module"></script></body></html>
<!DOCTYPE HTML><html lang="zh-CN"><head><meta charset="utf-8"><meta name="keywords" content="【RocketMQ学习】4.RocketMQ的高可用, Back-End Dev Java"><meta name="description" content="1 前言2 RocketMQ中的高可用机制RocketMQ分布式集群是通过 Master 和 Slave 的配合达到高可用性的。RocketMQ的HA架构

Master和Slave的区别：

在Broker的配置文件中，参数brokerI"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no"><meta name="renderer" content="webkit|ie-stand|ie-comp"><meta name="mobile-web-app-capable" content="yes"><meta name="format-detection" content="telephone=no"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="referrer" content="no-referrer-when-downgrade"><title>【RocketMQ学习】4.RocketMQ的高可用 | Kezade</title><link rel="icon" type="image/jpeg" href="https://gcore.jsdelivr.net/gh/zyxelva/zyxelva.github.io@main/medias/avatar/avatar2.jpg"><style>body{background-image:url(https://it-ark-dev.oss-cn-shenzhen.aliyuncs.com/464e9ac7a5a729ae67f91f7cf0cf6fe2.jpg);background-repeat:no-repeat;background-attachment:fixed;background-size:cover;background-position:center center}</style><link rel="stylesheet" href="https://gcore.jsdelivr.net/gh/zyxelva/zyxelva.github.io@main/libs/awesome/css/all.min.css"><link rel="stylesheet" href="https://gcore.jsdelivr.net/gh/zyxelva/zyxelva.github.io@main/libs/materialize/materialize.min.css"><link rel="stylesheet" href="https://gcore.jsdelivr.net/gh/zyxelva/zyxelva.github.io@main/libs/aos/aos.css"><link rel="stylesheet" href="https://gcore.jsdelivr.net/gh/zyxelva/zyxelva.github.io@main/libs/animate/animate.min.css"><link rel="stylesheet" href="https://gcore.jsdelivr.net/gh/zyxelva/zyxelva.github.io@main/libs/lightGallery/css/lightgallery.min.css"><link rel="stylesheet" href="https://gcore.jsdelivr.net/gh/zyxelva/picgo@v3.1/css/matery.css?v3"><link rel="stylesheet" href="https://gcore.jsdelivr.net/gh/zyxelva/zyxelva.github.io@main/css/my.css"><link rel="stylesheet" href="https://gcore.jsdelivr.net/gh/zyxelva/zyxelva.github.io@main/css/dark.css" media="none" onload='"all"!=media&&(media="all")'><link rel="stylesheet" href="https://gcore.jsdelivr.net/gh/zyxelva/zyxelva.github.io@main/libs/tocbot/tocbot.css"><link rel="stylesheet" href="https://gcore.jsdelivr.net/gh/zyxelva/zyxelva.github.io@main/css/post.css"><link rel="stylesheet" href="https://gcore.jsdelivr.net/gh/zyxelva/zyxelva.github.io@main/css/reward.css"><script src="https://gcore.jsdelivr.net/gh/zyxelva/zyxelva.github.io@main/libs/jquery/jquery-3.6.0.min.js"></script><script src="https://gcore.jsdelivr.net/gh/zyxelva/picgo@v3.3/js/function.js?v88"></script><script src="https://gcore.jsdelivr.net/gh/zyxelva/picgo@v1.3/js/imgStatus.min.js"></script><script src="https://gcore.jsdelivr.net/gh/zyxelva/picgo@v1.3/js/waterfall.min.js"></script><script src="https://gcore.jsdelivr.net/gh/zyxelva/picgo@v1.3/js/lately.min.js"></script><script>var memos={host:"https://s.dusays.com/",limit:"10",creatorId:"49",username:"zyxelva",name:"Kezade",domId:"#memos",path:"api/v1/memo"},douban={api:"https://douban-api.edui.fun/"}</script><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/rss2.xml" title="Kezade" type="application/rss+xml"></head><body><header class="navbar-fixed"><nav id="headNav" class="bg-color nav-transparent"><div id="navContainer" class="nav-wrapper container"><div class="brand-logo"><a href="/" class="waves-effect waves-light"><img src="https://gcore.jsdelivr.net/gh/zyxelva/zyxelva.github.io@main/medias/avatar/avatar2.jpg" class="logo-img k-avatar" alt="LOGO"> <span class="logo-span">Kezade</span></a></div><a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a><ul class="right nav-menu"><li class="hide-on-med-and-down nav-item"><a href="/" class="waves-effect waves-light"><i class="fas fa-home" style="zoom:0.6"></i> <span>首页</span></a></li><li class="hide-on-med-and-down nav-item"><a href="" class="waves-effect waves-light"><i class="fa-solid fa-newspaper" style="zoom:0.6"></i> <span>文章</span><i class="fas fa-chevron-down" aria-hidden="true" style="zoom:0.6"></i></a><ul class="sub-nav menus_item_child"><li><a href="/tags"><i class="fas fa-tags" style="margin-top:-20px;zoom:0.6"></i> <span>标签</span></a></li><li><a href="/categories"><i class="fas fa-bookmark" style="margin-top:-20px;zoom:0.6"></i> <span>分类</span></a></li><li><a href="/archives"><i class="fas fa-archive" style="margin-top:-20px;zoom:0.6"></i> <span>归档</span></a></li></ul></li><li class="hide-on-med-and-down nav-item"><a href="" class="waves-effect waves-light"><i class="fa-solid fa-sitemap" style="zoom:0.6"></i> <span>系列</span><i class="fas fa-chevron-down" aria-hidden="true" style="zoom:0.6"></i></a><ul class="sub-nav menus_item_child"><li><a href="/categories/%E7%AE%97%E6%B3%95"><i class="fa-solid fa-rocket" style="margin-top:-20px;zoom:0.6"></i> <span>算法学习</span></a></li><li><a href="/categories/RocketMQ%E5%AD%A6%E4%B9%A0"><i class="fa-solid fa-rocket" style="margin-top:-20px;zoom:0.6"></i> <span>RMQ学习</span></a></li><li><a href="/categories/Netty%E5%AD%A6%E4%B9%A0"><i class="fa-solid fa-rocket" style="margin-top:-20px;zoom:0.6"></i> <span>Netty学习</span></a></li><li><a href="/categories/Spring%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0"><i class="fa-solid fa-rocket" style="margin-top:-20px;zoom:0.6"></i> <span>Spring学习</span></a></li><li><a href="/categories/JVM%E5%AD%A6%E4%B9%A0"><i class="fa-solid fa-rocket" style="margin-top:-20px;zoom:0.6"></i> <span>JVM学习</span></a></li><li><a href="/categories/MySQL%E5%AD%A6%E4%B9%A0"><i class="fa-solid fa-rocket" style="margin-top:-20px;zoom:0.6"></i> <span>MySQL学习</span></a></li><li><a href="/categories/MyBatis%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0"><i class="fa-solid fa-rocket" style="margin-top:-20px;zoom:0.6"></i> <span>MyBatis学习</span></a></li><li><a href="/categories/Zookeeper%E5%AD%A6%E4%B9%A0"><i class="fa-solid fa-rocket" style="margin-top:-20px;zoom:0.6"></i> <span>ZK学习</span></a></li><li><a href="/categories/Hexo"><i class="fa-solid fa-rocket" style="margin-top:-20px;zoom:0.6"></i> <span>Hexo学习</span></a></li><li><a href="/categories/Redis%E5%AD%A6%E4%B9%A0"><i class="fa-solid fa-rocket" style="margin-top:-20px;zoom:0.6"></i> <span>Redis学习</span></a></li><li><a href="/categories/Docker%E5%AD%A6%E4%B9%A0"><i class="fa-solid fa-rocket" style="margin-top:-20px;zoom:0.6"></i> <span>Docker学习</span></a></li><li><a href="/categories/AP-Calculus"><i class="fa-solid fa-rocket" style="margin-top:-20px;zoom:0.6"></i> <span>AP学习</span></a></li><li><a href="/categories/A-Level"><i class="fa-solid fa-rocket" style="margin-top:-20px;zoom:0.6"></i> <span>A-Level学习</span></a></li><li><a href="/categories/SAT"><i class="fa-solid fa-rocket" style="margin-top:-20px;zoom:0.6"></i> <span>SAT学习</span></a></li><li><a href="/categories/%E8%80%83%E7%A0%94"><i class="fa-solid fa-rocket" style="margin-top:-20px;zoom:0.6"></i> <span>考研</span></a></li><li><a href="/categories/OSSD"><i class="fa-solid fa-rocket" style="margin-top:-20px;zoom:0.6"></i> <span>OSSD</span></a></li><li><a href="/categories/%E9%AB%98%E8%80%83"><i class="fa-solid fa-rocket" style="margin-top:-20px;zoom:0.6"></i> <span>高考</span></a></li></ul></li><li class="hide-on-med-and-down nav-item"><a href="" class="waves-effect waves-light"><i class="fa-solid fa-place-of-worship" style="zoom:0.6"></i> <span>我的</span><i class="fas fa-chevron-down" aria-hidden="true" style="zoom:0.6"></i></a><ul class="sub-nav menus_item_child"><li><a href="/galleries"><i class="fas fa-image" style="margin-top:-20px;zoom:0.6"></i> <span>相册</span></a></li><li><a href="/bibi"><i class="fa-fw fa-solid fa-cloud-rain" style="margin-top:-20px;zoom:0.6"></i> <span>哔哔</span></a></li><li><a href="/todolist"><i class="fa-fw fa-solid fa-circle-check" style="margin-top:-20px;zoom:0.6"></i> <span>清单</span></a></li><li><a href="/musics"><i class="fas fa-music" style="margin-top:-20px;zoom:0.6"></i> <span>音乐</span></a></li></ul></li><li class="hide-on-med-and-down nav-item"><a href="" class="waves-effect waves-light"><i class="fa-solid fa-circle-info" style="zoom:0.6"></i> <span>更多</span><i class="fas fa-chevron-down" aria-hidden="true" style="zoom:0.6"></i></a><ul class="sub-nav menus_item_child"><li><a href="/contact"><i class="fas fa-comments" style="margin-top:-20px;zoom:0.6"></i> <span>留言</span></a></li><li><a href="/friends"><i class="fa-solid fa-link" style="margin-top:-20px;zoom:0.6"></i> <span>友链</span></a></li><li><a href="/friend-circle"><i class="fa-solid fa-rss" style="margin-top:-20px;zoom:0.6"></i> <span>圈圈</span></a></li><li><a href="/about"><i class="fas fa-user-circle" style="margin-top:-20px;zoom:0.6"></i> <span>关于</span></a></li></ul></li><li><a href="#searchModal" class="modal-trigger waves-effect waves-light"><i id="searchIcon" class="fas fa-search" title="搜索" style="zoom:0.85"></i></a></li><li><a href="javascript:;" class="waves-effect waves-light" onclick="switchNightMode()" title="深色/浅色模式"><i id="sum-moon-icon" class="fas fa-sun" style="zoom:0.85"></i></a></li></ul><div id="mobile-nav" class="side-nav sidenav"><div class="mobile-head bg-color"><img src="https://gcore.jsdelivr.net/gh/zyxelva/zyxelva.github.io@main/medias/avatar/avatar2.jpg" class="logo-img circle responsive-img"><div class="logo-name">Kezade</div><div class="logo-desc">7 年 Java 开发经验，其中 3 年以上大型系统架构设计经验，以及 2 年以上的团队管理经验 | 具有分布式、高并发、高可用、大数据量的系统架构设计以及研发经验 | 对 Zookeeper、Netty、Dubbo、Spring Cloud、 Spring 等开源框架源码有过深入研究，并且有一定的框架定制开发经验</div></div><ul class="menu-list mobile-menu-list"><li class="m-nav-item"><a href="/" class="waves-effect waves-light"><i class="fa-fw fas fa-home"></i> 首页</a></li><li class="m-nav-item"><a href="javascript:;"><i class="fa-fw fa-solid fa-newspaper"></i> 文章<span class="m-icon"><i class="fas fa-chevron-right"></i></span></a><ul><li><a href="/tags" style="margin-left:75px"><i class="fa fas fa-tags" style="position:absolute;left:50px"></i> <span>标签</span></a></li><li><a href="/categories" style="margin-left:75px"><i class="fa fas fa-bookmark" style="position:absolute;left:50px"></i> <span>分类</span></a></li><li><a href="/archives" style="margin-left:75px"><i class="fa fas fa-archive" style="position:absolute;left:50px"></i> <span>归档</span></a></li></ul></li><li class="m-nav-item"><a href="javascript:;"><i class="fa-fw fa-solid fa-sitemap"></i> 系列<span class="m-icon"><i class="fas fa-chevron-right"></i></span></a><ul><li><a href="/categories/%E7%AE%97%E6%B3%95" style="margin-left:75px"><i class="fa fa-solid fa-rocket" style="position:absolute;left:50px"></i> <span>算法学习</span></a></li><li><a href="/categories/RocketMQ%E5%AD%A6%E4%B9%A0" style="margin-left:75px"><i class="fa fa-solid fa-rocket" style="position:absolute;left:50px"></i> <span>RMQ学习</span></a></li><li><a href="/categories/Netty%E5%AD%A6%E4%B9%A0" style="margin-left:75px"><i class="fa fa-solid fa-rocket" style="position:absolute;left:50px"></i> <span>Netty学习</span></a></li><li><a href="/categories/Spring%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0" style="margin-left:75px"><i class="fa fa-solid fa-rocket" style="position:absolute;left:50px"></i> <span>Spring学习</span></a></li><li><a href="/categories/JVM%E5%AD%A6%E4%B9%A0" style="margin-left:75px"><i class="fa fa-solid fa-rocket" style="position:absolute;left:50px"></i> <span>JVM学习</span></a></li><li><a href="/categories/MySQL%E5%AD%A6%E4%B9%A0" style="margin-left:75px"><i class="fa fa-solid fa-rocket" style="position:absolute;left:50px"></i> <span>MySQL学习</span></a></li><li><a href="/categories/MyBatis%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0" style="margin-left:75px"><i class="fa fa-solid fa-rocket" style="position:absolute;left:50px"></i> <span>MyBatis学习</span></a></li><li><a href="/categories/Zookeeper%E5%AD%A6%E4%B9%A0" style="margin-left:75px"><i class="fa fa-solid fa-rocket" style="position:absolute;left:50px"></i> <span>ZK学习</span></a></li><li><a href="/categories/Hexo" style="margin-left:75px"><i class="fa fa-solid fa-rocket" style="position:absolute;left:50px"></i> <span>Hexo学习</span></a></li><li><a href="/categories/Redis%E5%AD%A6%E4%B9%A0" style="margin-left:75px"><i class="fa fa-solid fa-rocket" style="position:absolute;left:50px"></i> <span>Redis学习</span></a></li><li><a href="/categories/Docker%E5%AD%A6%E4%B9%A0" style="margin-left:75px"><i class="fa fa-solid fa-rocket" style="position:absolute;left:50px"></i> <span>Docker学习</span></a></li><li><a href="/categories/AP-Calculus" style="margin-left:75px"><i class="fa fa-solid fa-rocket" style="position:absolute;left:50px"></i> <span>AP学习</span></a></li><li><a href="/categories/A-Level" style="margin-left:75px"><i class="fa fa-solid fa-rocket" style="position:absolute;left:50px"></i> <span>A-Level学习</span></a></li><li><a href="/categories/SAT" style="margin-left:75px"><i class="fa fa-solid fa-rocket" style="position:absolute;left:50px"></i> <span>SAT学习</span></a></li><li><a href="/categories/%E8%80%83%E7%A0%94" style="margin-left:75px"><i class="fa fa-solid fa-rocket" style="position:absolute;left:50px"></i> <span>考研</span></a></li><li><a href="/categories/OSSD" style="margin-left:75px"><i class="fa fa-solid fa-rocket" style="position:absolute;left:50px"></i> <span>OSSD</span></a></li><li><a href="/categories/%E9%AB%98%E8%80%83" style="margin-left:75px"><i class="fa fa-solid fa-rocket" style="position:absolute;left:50px"></i> <span>高考</span></a></li></ul></li><li class="m-nav-item"><a href="javascript:;"><i class="fa-fw fa-solid fa-place-of-worship"></i> 我的<span class="m-icon"><i class="fas fa-chevron-right"></i></span></a><ul><li><a href="/galleries" style="margin-left:75px"><i class="fa fas fa-image" style="position:absolute;left:50px"></i> <span>相册</span></a></li><li><a href="/bibi" style="margin-left:75px"><i class="fa fa-fw fa-solid fa-cloud-rain" style="position:absolute;left:50px"></i> <span>哔哔</span></a></li><li><a href="/todolist" style="margin-left:75px"><i class="fa fa-fw fa-solid fa-circle-check" style="position:absolute;left:50px"></i> <span>清单</span></a></li><li><a href="/musics" style="margin-left:75px"><i class="fa fas fa-music" style="position:absolute;left:50px"></i> <span>音乐</span></a></li></ul></li><li class="m-nav-item"><a href="javascript:;"><i class="fa-fw fa-solid fa-circle-info"></i> 更多<span class="m-icon"><i class="fas fa-chevron-right"></i></span></a><ul><li><a href="/contact" style="margin-left:75px"><i class="fa fas fa-comments" style="position:absolute;left:50px"></i> <span>留言</span></a></li><li><a href="/friends" style="margin-left:75px"><i class="fa fa-solid fa-link" style="position:absolute;left:50px"></i> <span>友链</span></a></li><li><a href="/friend-circle" style="margin-left:75px"><i class="fa fa-solid fa-rss" style="position:absolute;left:50px"></i> <span>圈圈</span></a></li><li><a href="/about" style="margin-left:75px"><i class="fa fas fa-user-circle" style="position:absolute;left:50px"></i> <span>关于</span></a></li></ul></li><li><div class="divider"></div></li><li><a href="https://github.com/blinkfox/hexo-theme-matery" class="waves-effect waves-light" target="_blank"><i class="fab fa-github-square fa-fw"></i> Fork Me</a></li></ul></div></div><style>.nav-transparent .github-corner{display:none!important}.github-corner{position:absolute;z-index:10;top:0;right:0;border:0;transform:scale(1.1)}.github-corner svg{color:#0f9d58;fill:#fff;height:64px;width:64px}.github-corner:hover .octo-arm{animation:a .56s ease-in-out}.github-corner .octo-arm{animation:none}@keyframes a{0%,to{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}</style><a href="https://github.com/blinkfox/hexo-theme-matery" class="github-corner tooltipped hide-on-med-and-down" target="_blank" data-tooltip="Fork Me" data-position="left" data-delay="50"><svg viewBox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115 130 115 142 142 250 250 250 0Z"></path><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"></path><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4L133.7 101.6C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8Z" fill="currentColor" class="octo-body"></path></svg></a></nav></header><script src="https://gcore.jsdelivr.net/gh/zyxelva/zyxelva.github.io@main/libs/cryptojs/crypto-js.min.js"></script><script></script><style>:root{--post-bg-image:url('https://gcore.jsdelivr.net/gh/zyxelva/zyxelva.github.io@main/medias/RocketMQ2.png')}</style><div class="bg-cover pd-header post-cover"><div class="container" style="right:0;left:0"><div class="row"><div class="col s12 m12 l12"><div class="brand"><h1 class="description center-align post-title">【RocketMQ学习】4.RocketMQ的高可用</h1></div></div></div></div></div><main class="post-container content"><div class="row"><div id="main-content" class="col s12 m12 l9"><div id="artDetail"><div class="card"><div class="card-content article-info"><div class="row tag-cate"><div class="col s7"><div class="article-tag"><a href="/tags/RocketMQ/"><span class="chip bg-color">RocketMQ</span></a> <a href="/tags/%E9%AB%98%E5%8F%AF%E7%94%A8/"><span class="chip bg-color">高可用</span></a></div></div><div class="col s5 right-align"><div class="post-cate"><i class="fas fa-bookmark fa-fw icon-category"></i> <a href="/categories/RocketMQ%E5%AD%A6%E4%B9%A0/" class="post-category">RocketMQ学习</a></div></div></div><div class="post-info"><div class="post-date info-break-policy"><i class="far fa-calendar-minus fa-fw"></i> 发布日期:&nbsp;&nbsp; 2023-07-19</div><div class="info-break-policy"><i class="far fa-file-word fa-fw"></i> 文章字数:&nbsp;&nbsp; 5k</div><div class="info-break-policy"><i class="far fa-clock fa-fw"></i> 阅读时长:&nbsp;&nbsp; 18 分</div></div></div><hr class="clearfix"><link rel="stylesheet" href="https://gcore.jsdelivr.net/gh/zyxelva/zyxelva.github.io@main/libs/prism/prism.min.css"><div class="card-content article-card-content"><div id="articleContent"><h1 id="1-前言"><a href="#1-前言" class="headerlink" title="1 前言"></a>1 前言</h1><h1 id="2-RocketMQ中的高可用机制"><a href="#2-RocketMQ中的高可用机制" class="headerlink" title="2 RocketMQ中的高可用机制"></a>2 RocketMQ中的高可用机制</h1><p>RocketMQ分布式集群是通过 <code>Master</code> 和 <code>Slave</code> 的配合达到高可用性的。<br><img src="https://gcore.jsdelivr.net/gh/zyxelva/picgo/markdown/rocketmq-HA.png"></p><div class="caption"><b class="center-caption">RocketMQ的HA架构</b></div><p></p><blockquote><p>Master和Slave的区别：</p><ul><li>在Broker的配置文件中，参数<code>brokerId</code>的值为<code>0</code>，表明这个Broker是<code>Master</code>，<code>大于0</code>表明这个Broker是<code>Slave</code>，同时<code>brokerRole</code>参数也会说明这个Broker是<code>Master</code>还是<code>Slave</code>。</li><li><code>Master</code>角色的<code>Broker</code>支持<code>读和写</code>，<code>Slave</code>角色的Broker<code>仅支持读</code>。</li></ul></blockquote><h2 id="2-1-集群部署模式"><a href="#2-1-集群部署模式" class="headerlink" title="2.1 集群部署模式"></a>2.1 集群部署模式</h2><h3 id="2-1-1-单master-模式"><a href="#2-1-1-单master-模式" class="headerlink" title="2.1.1 单master 模式"></a>2.1.1 单master 模式</h3><p>只有一个 master 节点，称不上是集群，一旦这个 master 节点宕机，那么整个服务就不可用。</p><ul><li>优点： 本地开发测试，配置简单，同步刷盘消息不会丢失。</li><li>缺点： 不可靠，如果宕机会导致服务不可用。</li></ul><h3 id="2-1-2-多master-模式"><a href="#2-1-2-多master-模式" class="headerlink" title="2.1.2 多master 模式"></a>2.1.2 多master 模式</h3><p>多个 master 节点组成集群，单个 master 节点宕机或者重启对应用<code>没有影响</code>。</p><ul><li>优点：所有模式中性能最高（一个Topic 的可以分布在不同的master，进行横向拓展）。</li><li>缺点：单个master 节点宕机期间，<code>未被消费的消息</code>在节点恢复之前<code>不可用</code>，消息的实时性就受到影响。</li></ul><h3 id="2-1-3-多master-多slave-异步复制模式"><a href="#2-1-3-多master-多slave-异步复制模式" class="headerlink" title="2.1.3 多master 多slave + 异步复制模式"></a>2.1.3 多master 多slave + 异步复制模式</h3><p><code>从节点</code>(Slave)就是复制主节点的数据，对于生产者完全感知不到，对于消费者正常情况下也感知不到。(只有当 Master 不可用或者繁忙的时候， Consumer 会被自动切换到从 Slave 读。)</p><p>在多 master 模式的基础上，每个 master 节点都有<code>至少一个</code>对应的 slave。master 节点可读可写，但是 slave 只能读不能写，类似于 mysql 的主备模式。</p><ul><li>优点： 一般情况下都是master消费，在master 宕机或超过负载时，消费者可以从slave 读取消息，消息的实时性不会受影响，性能几乎和多master一样。</li><li>缺点：使用异步复制的同步方式有可能会有消息丢失的问题。（Master 宕机后，生产者发送的消息没有消费完，同时到Slave 节点的数据也没有同步完）。<h3 id="2-1-4-多master-多slave-主从同步复制-异步刷盘（最优推荐）"><a href="#2-1-4-多master-多slave-主从同步复制-异步刷盘（最优推荐）" class="headerlink" title="2.1.4 多master 多slave 主从同步复制+异步刷盘（最优推荐）"></a>2.1.4 多master 多slave 主从同步复制+异步刷盘（最优推荐）</h3></li><li>优点：主从同步复制模式能保证数据不丢失。</li><li>缺点：发送单个消息响应时间会略长，性能相比异步复制<code>低10%左右</code>。</li></ul><h3 id="2-1-5-DLedger1"><a href="#2-1-5-DLedger1" class="headerlink" title="2.1.5 DLedger1"></a>2.1.5 DLedger<sup><a href="#fn_1" id="reffn_1">1</a></sup></h3><p>类似于<code>Zookeeper</code>的<code>集群选举模式</code>（raft协议）。</p><p><code>DLedger</code>是一套基于<code>Raft协议</code>的<code>分布式日志存储组件</code>，也是 RocketMQ 实现新的高可用多副本架构的关键。<br><img src="https://gcore.jsdelivr.net/gh/zyxelva/picgo/markdown/Dledger-Arch.png"></p><div class="caption"><b class="center-caption">DLedger模式架构图</b></div><p></p><p><code>RocketMQ 4.5</code> 版本发布后，可以采用 <code>RocketMQ on DLedger</code> 方式进行部署。<code>DLedger CommitLog</code>代替了原来的 <code>CommitLog</code>，使得 CommitLog 拥有了<code>选举复制</code>能力，然后通过角色透传的方式，raft 角色透传给外部 broker 角色，leader 对应原来的 master，follower 和 candidate 对应原来的 slave。</p><p>因此 RocketMQ 的 broker 拥有了<code>自动故障转移</code>的能力，在一组 broker 中如果 Master 挂了，能够依靠 DLedger 自动选主能力重新选出一个 leader，然后通过角色透传变成新的 Master。</p><p>但是存在一些缺点：</p><ul><li>想要具备选举切换的能力，单组 Broker 内的副本数必须 <code>3 副本及以上</code>(Raft协议决定)；</li><li>副本 <code>ACK</code> 需要严格遵循 Raft 协议多数派的限制，3 副本需要 2 副本 ACK 后才能返回，5 副本需要 3 副本 ACK 后才能返回，副本越多可能耗时也可能越长。(这个也是最重要的一点)；</li><li>DLedger 模式下，由于存储库使用了 <code>OpenMessaging DLedger</code> 存储，因此<strong>无法复用</strong> RocketMQ 原生的存储和复制的能力（比如 transientStorePool 和零拷贝能力），且对维护造成了困难。</li></ul><p>在<code>RocketMQ5.0</code>版本新增了<code>DLedger Controller模式</code>来解决上面对的痛点。</p><h3 id="2-1-6-DLedger-Controller模式架构2"><a href="#2-1-6-DLedger-Controller模式架构2" class="headerlink" title="2.1.6 DLedger Controller模式架构2"></a>2.1.6 DLedger Controller模式架构<sup><a href="#fn_2" id="reffn_2">2</a></sup></h3><p>DLedger Controller模式的<strong>核心思想</strong>：将其作为一个选主组件，并且是一个<code>可选择</code>、<code>松耦合</code>的组件。当部署 DLedger Controller 组件后，原本 Master-Slave 部署模式下 Broker 组就拥有 <code>Failover</code> 能力。<br><img src="https://gcore.jsdelivr.net/gh/zyxelva/picgo/markdown/RocketMQ_controller_design_1.png"></p><div class="caption"><b class="center-caption">DLedger Controller模式架构</b></div><br>其中：<p></p><ul><li><code>DledgerController</code>：利⽤ DLedger ，构建⼀个保证元数据强⼀致性的 DLedger Controller 控制器，利⽤ Raft 选举会选出⼀个 Active DLedger Controller 作为主控制器，DLedger Controller 可以内嵌在 Nameserver中，也可以独立的部署。其主要作用是，用来存储和管理 Broker 的 SyncStateSet 列表，并在某个 Broker 的 Master Broker 下线或⽹络隔离时，主动发出调度指令来切换 Broker 的 Master。</li><li><code>SyncStateSet</code>：主要表示⼀个 broker 副本组中跟上 Master 的 Slave 副本加上 Master 的集合。主要判断标准是 Master 和 Slave 之间的差距。当 Master 下线时，我们会从 SyncStateSet 列表中选出新的 Master。 SyncStateSet 列表的变更主要由 Master Broker 发起。Master通过定时任务判断和同步过程中完成 SyncStateSet 的Shrink 和 Expand，并向选举组件 Controller 发起 Alter SyncStateSet 请求。</li><li><code>AutoSwitchHAService</code>：一个新的 HAService，在 DefaultHAService 的基础上，支持 BrokerRole 的切换，支持 Master 和 Slave 之间互相转换 (在 Controller 的控制下) 。此外，该 HAService 统一了日志复制流程，会在 HA HandShake 阶段进行日志的截断。</li><li><code>ReplicasManager</code>：作为一个中间组件，起到承上启下的作用。对上，可以定期同步来自 Controller 的控制指令，对下，可以定期监控 HAService 的状态，并在合适的时间修改 SyncStateSet。ReplicasManager 会定期同步 Controller 中关于该 Broker 的元数据，当 Controller 选举出一个新的 Master 的时候，ReplicasManager 能够感知到元数据的变化，并进行 BrokerRole 的切换。</li></ul><p>核心设计<sup><a href="#fn_3" id="reffn_3">3</a></sup>：<br><img src="https://gcore.jsdelivr.net/gh/zyxelva/picgo/markdown/RocketMQ-Controller-Arch.png"></p><div class="caption"><b class="center-caption">DLedgerController 核心设计</b></div><p></p><blockquote><p>详细可参考<a target="_blank" rel="noopener" href="https://github.com/apache/rocketmq/blob/develop/docs/cn/controller/design.md">设计思想</a>.</p></blockquote><p>Controller 部署有两种方式。</p><ul><li>嵌入于 NameServer 进行部署<img src="https://gcore.jsdelivr.net/gh/zyxelva/picgo/markdown/Controller-as-plugin.png"><div class="caption"><b class="center-caption">“嵌入部署”</b></div></li><li>独立部署，需要单独部署 Controller 组件<img src="https://gcore.jsdelivr.net/gh/zyxelva/picgo/markdown/Controller-deploy-indepdent.png"><div class="caption"><b class="center-caption">“独立部署”</b></div></li></ul><blockquote><p>详情参考<a target="_blank" rel="noopener" href="https://rocketmq.apache.org/zh/docs/deploymentOperations/03autofailover">主备自动切换模式部署</a>.</p></blockquote><h2 id="2-2-刷盘与主从同步"><a href="#2-2-刷盘与主从同步" class="headerlink" title="2.2 刷盘与主从同步"></a>2.2 刷盘与主从同步</h2><h3 id="2-2-1-刷盘"><a href="#2-2-1-刷盘" class="headerlink" title="2.2.1 刷盘"></a>2.2.1 刷盘</h3><p>刷盘，即将数据从内存写入磁盘。在RocketMQ中就是将消息落地，这样既能<code>保证断电后恢复</code>， 又可以让<code>存储的消息量超出内存的限制</code>。RocketMQ 为了提高性能，会尽可能地保证磁盘的<code>顺序写</code>。消息在通过 Producer 写入 RocketMQ 的时候，有两种写磁盘方式。</p><h4 id="2-2-1-1-同步刷盘"><a href="#2-2-1-1-同步刷盘" class="headerlink" title="2.2.1.1 同步刷盘"></a>2.2.1.1 同步刷盘</h4><p>生产者发送的每一条消息都在<code>保存到磁盘成功后</code>才返回告诉生产者成功。这种方式不会存在消息丢失的问题，但是有很大的磁盘IO开销，性能有一定影响。</p><h4 id="2-2-1-2-异步刷盘"><a href="#2-2-1-2-异步刷盘" class="headerlink" title="2.2.1.2 异步刷盘"></a>2.2.1.2 异步刷盘</h4><p>生产者发送的每一条消息<code>并不是立即保存到磁盘</code>，而是<code>暂时缓存</code>起来，然后就返回生产者成功。随后再<code>异步</code>的将缓存数据<code>保存</code>到磁盘。<br>有两种情况：</p><ul><li><code>定期</code>将缓存中更新的数据进行刷盘</li><li>当缓存中更新的数据条数达到<code>某一设定值</code>后进行刷盘。</li></ul><p>这种异步的方式会<code>存在消息丢失</code>(在还未来得及同步到磁盘的时候宕机)，但是性能很好。<code>默认是这种模式</code>。</p><h3 id="2-2-2-主从同步"><a href="#2-2-2-主从同步" class="headerlink" title="2.2.2 主从同步"></a>2.2.2 主从同步</h3><p>集群环境下需要部署多个 Broker，Broker 分为两种角色：</p><ul><li>一种是 master，<code>既可以写也可以读</code>，其 <code>brokerId=0</code>，<code>只能有一个</code>；</li><li>另外一种是 slave，<code>只允许读</code>，其 <code>brokerId</code> 为<code>非 0</code>。</li></ul><p>一个 master 与多个 slave 通过指定<code>相同的brokerClusterName</code> 被归为一个 <code>broker set</code>(broker 集)。通常生产环境中，我们至少需要 2 个 <code>broker set</code>。Slave 用于复制 master 的数据。</p><p>一个 Broker 组有 Master 和 Slave，消息需要从 Master 复制到 Slave 上，有<code>同步</code>和<code>异步</code>两种复制方式。</p><h4 id="2-2-2-1-同步复制"><a href="#2-2-2-1-同步复制" class="headerlink" title="2.2.2.1 同步复制"></a>2.2.2.1 同步复制</h4><p>生产者发送的每一条消息都<code>至少同步复制到一个 slave 后</code>才返回告诉生产者成功，即<code>同步双写</code>。</p><p>在同步复制方式下，如果 Master 出故障， Slave 上有全部的备份数据，容易恢复，但是同步复制会增大数据<code>写入延迟</code>，<code>降低系统吞吐量</code>。</p><h4 id="2-2-2-2-异步复制"><a href="#2-2-2-2-异步复制" class="headerlink" title="2.2.2.2 异步复制"></a>2.2.2.2 异步复制</h4><p>生产者发送的每一条消息只要写入 master 就返回告诉生产者成功。然后再<code>异步复制</code>到 slave。</p><p>在异步复制方式下，系统拥有<code>较低的延迟</code>和<code>较高的吞吐量</code>，但是如果 Master 出了故障，有些数据因为没有被写入 Slave，有可能会<code>丢失</code>。</p><h3 id="2-2-3-配置参数及意义"><a href="#2-2-3-配置参数及意义" class="headerlink" title="2.2.3 配置参数及意义"></a>2.2.3 配置参数及意义</h3><div class="table-container"><table><thead><tr><th>broker参数</th><th>意义</th></tr></thead><tbody><tr><td>brokerId=0</td><td>代表主</td></tr><tr><td>brokerId=1</td><td>代表从(大于 0 都代表从)</td></tr><tr><td>brokerRole=SYNC_MASTER</td><td>同步复制(主从)</td></tr><tr><td>brokerRole=ASYNC_MASTER</td><td>异步复制(主从)</td></tr><tr><td>flushDiskType=SYNC_FLUSH</td><td>同步刷盘</td></tr><tr><td>flushDiskType=ASYNC_FLUSH</td><td>异步刷盘</td><td>.</td></tr></tbody></table></div><h1 id="3-消息生产的高可用机制"><a href="#3-消息生产的高可用机制" class="headerlink" title="3 消息生产的高可用机制"></a>3 消息生产的高可用机制</h1><p>在创建Topic的时候，把Topic的多个<code>Message Queue</code>创建在<code>多个Broker组</code>上（相同Broker名称，不同 brokerId的机器组成一个Broker组），这样当一个Broker组的Master不可用后，其他组的Master仍然可用，Producer仍然可以发送消息。<br><img src="https://gcore.jsdelivr.net/gh/zyxelva/picgo/markdown/broker-group.png"></p><div class="caption"><b class="center-caption">Broker组</b></div><p></p><h2 id="3-1-高可用消息生产流程"><a href="#3-1-高可用消息生产流程" class="headerlink" title="3.1 高可用消息生产流程"></a>3.1 高可用消息生产流程</h2><img src="https://gcore.jsdelivr.net/gh/zyxelva/picgo/markdown/Producer-HA-Flow.png"><div class="caption"><b class="center-caption">高可用消息生产流程</b></div><ul><li><code>TopicA</code>创建在双主<code>BrokerA</code>和<code>BrokerB</code>中，每一个Broker 中有<code>4 个队列</code>；</li><li>选择队列时，默认使用<code>轮训</code>的方式，比如发送一条消息A 时，选择<code>BrokerA</code>中的<code>Q4</code>；</li><li>如果发送成功，消息A发送结束；</li><li>如果消息发送失败，默认会采用<code>重试机制</code>，这里有一个<code>规避策略</code>（默认配置）：<ul><li>默认<code>不启用</code>Broker故障延迟机制（规避策略）：如果是BrokerA宕机，上一次路由选择的是BrokerA中的Q4，那么再次重发的队列选择是BrokerA中的Q1。但是这里的问题就是消息发送很大可能再次失败，引发再次重复失败，带来不必要的性能损耗。<blockquote><p>为什么会默认这么设计？<br>1、某一时间段，从<code>NameServer</code>中读到的路由中包含了<code>不可用的主机</code>；<br>2、不正常的路由信息也是只是一个短暂的时间而已。<br><code>生产者</code><strong>每隔30s</strong>更新一次路由信息，而<code>NameServer</code>认为broker不可用需要经过<code>120s</code>。所以<code>生产者要发送时认为broker不正常</code>（从NameServer拿到）和<code>实际Broker不正常</code>有<strong>延迟</strong>。</p></blockquote></li></ul></li></ul><img src="https://gcore.jsdelivr.net/gh/zyxelva/picgo/markdown/broker-health-check.png"><div class="caption"><b class="center-caption">broker检测机制流程</b></div><blockquote><p>为什么默认不启用？<br>如果所有的 Broker 都触发了<code>故障规避</code>，并且 Broker 只是<code>那一瞬间压力大</code>，那岂不是明明存在可用的 Broker，但经过你这样规避，反倒是没有 Broker 可用来，那岂不是更糟糕了。</p><ul><li>启用Broker 故障延迟机制：开启延迟规避机制，一旦消息发送失败（不是重试的）会将 BrokerA“悲观”地认为在接下来的一段时间内<code>不可用</code>，在未来某一段时间内所有的客户端不会向该 Broker 发送消息。</li></ul><p>注意，这里的规避仅仅只针对<code>消息重试</code>，例如在一次消息发送过程中如果遇到消息发送失败，规避 BrokerA，但是在下一次消息发送时，即再次调用 <code>DefaultMQProducer</code> 的 <code>send 方法</code>发送消息时，还是会选择 BrokerA 的消息进行发送，<strong>只有继续发送失败后，重试时再次规避 BrokerA</strong>。</p><h1 id="4-消息消费的高可用机制"><a href="#4-消息消费的高可用机制" class="headerlink" title="4 消息消费的高可用机制"></a>4 消息消费的高可用机制</h1><p>在Consumer的配置文件中，并<strong>不需要设置</strong>是从Master读还是从Slave读，当Master<code>不可用</code>或者<code>繁忙</code>的时候，Consumer会被<code>自动切换</code>到从Slave 读。有了自动切换Consumer这种机制，当一个Master角色的机器出现故障后，Consumer仍然可以从Slave读取消息，不影响Consumer程序。这就达到了消费端的高可用性。<br>什么是Master繁忙呢？<br>这个繁忙其实是RocketMQ服务器的<code>内存不够</code>导致的。<br>比如，10w的消息，只消费了2w，还有8w待消费，而master最多只能用10GB的OS cache，只能缓存5w条数据，还有3w就要去磁盘中拉取，此时他就会认为可能是master负载太高了，你去slave拉取吧。</p></blockquote><h2 id="4-1-消息消费重试"><a href="#4-1-消息消费重试" class="headerlink" title="4.1 消息消费重试"></a>4.1 消息消费重试</h2><p>消费端如果发生消息失败，没有提交成功，消息<code>默认情况下</code>会进入重试队列中。</p><p>重试队列的名字其实是跟<code>消费群组</code>有关，<code>不是主题</code>，<strong>因为一个主题可以有多个群组消费</strong>。</p><h3 id="4-1-1-顺序消息的重试"><a href="#4-1-1-顺序消息的重试" class="headerlink" title="4.1.1 顺序消息的重试"></a>4.1.1 顺序消息的重试</h3><p>对于顺序消息，当消费者消费消息失败后，消息队列 RocketMQ 会<code>自动不断</code>进行消息重试（每次间隔时间为 1 秒），这时，应用会出现消息消费被阻塞的情况。因此，在使用顺序消息时，务必保证应用能够及时监控并处理消费失败的情况，避免阻塞现象的发生。</p><p>在玩顺序消息时。consumer消费消息失败时，不能返回<code>reconsume_later</code>，这样会导致<code>乱序</code>，应该返回<code>suspend_current_queue_a_moment</code>，意思是先等一会，一会儿再处理这批消息，而不是放到重试队列里。</p><h3 id="4-1-2-无序消息的重试"><a href="#4-1-2-无序消息的重试" class="headerlink" title="4.1.2 无序消息的重试"></a>4.1.2 无序消息的重试</h3><p>对于无序消息（普通、定时、延时、事务消息），当消费者消费消息失败时，您可以通过<code>设置返回状态</code>达到消息重试的结果。</p><p>无序消息的重试只针对<code>集群消费方式</code>生效；广播方式<code>不提供</code>失败重试特性，即消费失败后，失败消息不再重试，继续消费新的消息。</p><h3 id="4-1-3-重试次数"><a href="#4-1-3-重试次数" class="headerlink" title="4.1.3 重试次数"></a>4.1.3 重试次数</h3><p>如下表所示：</p><div class="table-container"><table><thead><tr><th>第几次重试</th><th>与上次重试的间隔时间</th><th>第几次重试</th><th>与上次重试的间隔时间</th></tr></thead><tbody><tr><td>1</td><td>10 秒</td><td>9</td><td>7 分钟</td></tr><tr><td>2</td><td>30 秒</td><td>10</td><td>8 分钟</td></tr><tr><td>3</td><td>1 分钟</td><td>11</td><td>9 分钟</td></tr><tr><td>4</td><td>2 分钟</td><td>12</td><td>10 分钟</td></tr><tr><td>5</td><td>3 分钟</td><td>13</td><td>20 分钟</td></tr><tr><td>6</td><td>4 分钟</td><td>14</td><td>30 分钟</td></tr><tr><td>7</td><td>5 分钟</td><td>15</td><td>1 小时</td></tr><tr><td>8</td><td>6 分钟</td><td>16</td><td>2 小时</td></tr></tbody></table></div><p>如果消息重试 <code>16次</code>后仍然失败，消息将不再投递。如果严格按照上述重试时间间隔计算，某条消息在一直消费失败的前提下，将会在接下来的 <code>4 小时 46 分钟</code>之内进行 16 次重试，<strong>超过这个时间范围消息将不再重试投递</strong>。</p><blockquote><p>注意： 一条消息无论重试多少次，这些重试消息的 <code>Message ID 不会改变</code>。</p></blockquote><h3 id="4-1-4-自定义消息最大重试次数"><a href="#4-1-4-自定义消息最大重试次数" class="headerlink" title="4.1.4 自定义消息最大重试次数"></a>4.1.4 自定义消息最大重试次数</h3><p>消息队列 RocketMQ 允许 Consumer 启动的时候设置<code>最大重试次数</code>，重试时间间隔将按照如下策略：</p><ul><li>最大重试次数<code>小于等于 16 次</code>，则重试时间间隔同上表描述。</li><li>最大重试次数<code>大于 16 次</code>，超过 16 次的重试时间间隔均为<code>每次 2 小时</code>。</li></ul><p>另外：</p><ul><li>消息最大重试次数的设置对<code>相同Group ID</code>下的<strong>所有 Consumer 实例有效</strong>。</li><li>如果只对<code>相同Group ID</code>下两个 Consumer 实例中的其中一个设置了 <code>MaxReconsumeTimes</code>，那么该配置对两个 Consumer 实例均生效。</li><li>配置采用<code>覆盖</code>的方式生效，即最后启动的 Consumer 实例会覆盖之前的启动实例的配置。</li></ul><h2 id="4-2-死信队列"><a href="#4-2-死信队列" class="headerlink" title="4.2 死信队列"></a>4.2 死信队列</h2><p>当一条消息<code>初次</code>消费失败，消息队列 RocketMQ 会<code>自动</code>进行消息重试；达到最大重试次数后，若消费依然失败，则表明消费者在<code>正常情况下</code>无法正确地消费该消息，此时，消息队列 RocketMQ <strong>不会立刻将消息丢弃</strong>，而是将其发送到该消费者对应的特殊队列中。</p><p>在消息队列 RocketMQ 中，这种正常情况下无法被消费的消息称为<code>死信消息</code>（Dead-Letter Message），存储死信消息的特殊队列称为<code>死信队列</code>（Dead-Letter Queue）。</p><h3 id="4-2-1-特性"><a href="#4-2-1-特性" class="headerlink" title="4.2.1 特性"></a>4.2.1 特性</h3><p><code>死信消息</code>具有以下特性：</p><ul><li><strong>不会再被消费者正常消费</strong>。</li><li>有效期与正常消息相同，均为<code>3天</code>，3 天后会被自动删除。因此，<strong>请在死信消息产生后的 3 天内及时处理</strong>。</li></ul><p><code>死信队列</code>具有以下特性：</p><ul><li><strong>不会再被消费者正常消费</strong>。</li><li>一个死信队列对应一个 <code>Group ID</code>， 而不是对应单个消费者实例。</li><li>如果一个 Group ID 未产生死信消息，消息队列 RocketMQ 不会为其创建相应的死信队列。</li><li>一个死信队列包含了对应 Group ID 产生的所有死信消息，不论该消息属于哪个 Topic。</li></ul><blockquote><p>一条消息进入死信队列，意味着某些因素导致消费者无法正常消费该消息，因此，通常需要您对其进行特殊处理。<strong>排查可疑因素并解决问题后</strong>，可以在消息队列 RocketMQ 控制台<code>重新发送</code>该消息，让消费者重新消费一次。</p></blockquote><h1 id="5-负载均衡"><a href="#5-负载均衡" class="headerlink" title="5 负载均衡"></a>5 负载均衡</h1><h2 id="5-1-Producer负载均衡"><a href="#5-1-Producer负载均衡" class="headerlink" title="5.1 Producer负载均衡"></a>5.1 Producer负载均衡</h2><p>Producer端，每个实例在发消息的时候，默认会<code>轮询</code>所有的<code>message queue</code>发送，以达到让消息平均落在不同的queue上。而由于queue可以散落在不同的broker，所以消息就发送到不同的broker下，如下图：<br><img src="https://gcore.jsdelivr.net/gh/zyxelva/picgo/markdown/producer-lb.png"></p><div class="caption"><b class="center-caption">Producer端的负载均衡</b></div><p></p><h2 id="5-2-Consumer负载均衡"><a href="#5-2-Consumer负载均衡" class="headerlink" title="5.2 Consumer负载均衡"></a>5.2 Consumer负载均衡</h2><h3 id="5-2-1-集群模式"><a href="#5-2-1-集群模式" class="headerlink" title="5.2.1 集群模式"></a>5.2.1 集群模式</h3><p>在<code>集群消费模式</code>下，每条消息只需要投递到订阅这个topic的<code>Consumer Group</code>下的<code>一个实例</code>即可。RocketMQ采用<code>主动拉取</code>的方式拉取并消费消息，在拉取的时候需要明确指定拉取哪一条message queue。</p><p>而每当实例的数量有变更，都会触发一次所有实例的负载均衡，这时候会按照queue的数量和实例的数量平均分配queue给每个实例。</p><p>默认的分配算法是<code>AllocateMessageQueueAveragely</code>，还有另外一种平均的算法是<code>AllocateMessageQueueAveragelyByCircle</code>，也是平均分摊每一条queue，只是以环状轮流分queue的形式。</p><blockquote><p>还有其他分配策略，比如：<code>AllocateMessageQueueByConfig</code>、<code>AllocateMessageQueueByMachineRoom</code>、<code>AllocateMessageQueueConsistentHash</code>、<code>AllocateMachineRoomNearby</code>。</p><ul><li><code>AVG_BY_CIRCLE</code>， 跟<code>AVG</code>类似，只是分到的queue不是连续的。比如一共12个Queue，3个consumer，则第一个consumer接收queue1，4，7，9的消息；第二个接收2，5，8，11；第三个接收3，6，9，12。“我一个，你一个，他一个”，AVG则是“前四个是我的，中间四个是你的，剩下的是他的”；</li><li><code>CONSISTENT_HASH</code>，使用一致性hash算法来分配Queue，用户需自定义虚拟节点的数量；</li><li><code>MACHINE_ROOM</code>，将queue先按照broker划分几个<code>computer room</code>，不同的consumer只消费某几个broker上的消息；</li><li><code>CONFIG</code>，用户启动时指定消费哪些Queue的消息。</li></ul></blockquote><img src="https://gcore.jsdelivr.net/gh/zyxelva/picgo/markdown/consumer-lb.png"><div class="caption"><b class="center-caption">Consumer端的负载均衡</b></div><p>需要注意的是，集群模式下，<code>queue</code>都是<strong>只允许分配只一个实例</strong>，这是由于如果多个实例同时消费一个queue的消息，由于拉取哪些消息是consumer主动控制的，那样会导致同一个消息在不同的实例下<code>被消费多次</code>，所以算法上都是一个queue只分给一个consumer实例，一个consumer实例可以允许同时分到不同的queue。</p><p>通过增加consumer实例去分摊queue的消费，可以起到水平扩展的消费能力的作用。而在有实例下线的时候，会重新触发负载均衡，这时候原来分配到的queue将分配到其他实例上继续消费。</p><blockquote><p>如果consumer 实例的数量比message queue 的总数量还多的话，多出来的consumer 实例将无法分到queue，因此需要控制让<code>queue 的总数量大于等于consumer 的数量</code>。</p></blockquote><h3 id="5-2-2-广播模式"><a href="#5-2-2-广播模式" class="headerlink" title="5.2.2 广播模式"></a>5.2.2 广播模式</h3><p>由于广播模式下要求一条消息需要投递到一个消费组下面所有的消费者实例，所以也就没有消息被分摊消费的说法。</p><h1 id="6-参考文献"><a href="#6-参考文献" class="headerlink" title="6 参考文献"></a>6 参考文献</h1><p><sup><a href="#fn_1" id="reffn_1">1</a></sup> <a target="_blank" rel="noopener" href="https://www.yii666.com/article/567736.html">Docker 部署 RocketMQ Dledger 集群模式（ 版本v4.7.0）</a><br><sup><a href="#fn_2" id="reffn_2">2</a></sup> <a target="_blank" rel="noopener" href="https://blog.csdn.net/Huangjiazhen711/article/details/127221881">RocketMQ5.0 DLedger Controller模式</a><br><sup><a href="#fn_3" id="reffn_3">3</a></sup> <a target="_blank" rel="noopener" href="https://rocketmq.apache.org/zh/docs/deploymentOperations/03autofailover">主备自动切换模式部署</a></p></div><hr><div class="reprint" id="reprint-statement"><div class="reprint__author"><span class="reprint-meta" style="font-weight:700"><i class="fas fa-user">文章作者:</i></span> <span class="reprint-info"><a href="/about" rel="external nofollow noreferrer">Kezade</a></span></div><div class="reprint__type"><span class="reprint-meta" style="font-weight:700"><i class="fas fa-link">文章链接:</i></span> <span class="reprint-info"><a href="https://zyxelva.github.io/posts/408598183.html">https://zyxelva.github.io/posts/408598183.html</a></span></div><div class="reprint__notice"><span class="reprint-meta" style="font-weight:700"><i class="fas fa-copyright">版权声明:</i></span> <span class="reprint-info">本博客所有文章除特別声明外，均采用 <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a> 许可协议。转载请注明来源 <a href="/about" target="_blank">Kezade</a> !</span></div></div><script async defer>function navToReprintStatement(){$("html, body").animate({scrollTop:$("#reprint-statement").offset().top-80},800)}document.addEventListener("copy",function(t){M.toast({html:'<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>'})})</script><div class="tag_share" style="display:block"><div class="post-meta__tag-list" style="display:inline-block"><div class="article-tag"><a href="/tags/RocketMQ/"><span class="chip bg-color">RocketMQ</span></a> <a href="/tags/%E9%AB%98%E5%8F%AF%E7%94%A8/"><span class="chip bg-color">高可用</span></a></div></div><div class="post_share" style="zoom:80%;width:fit-content;display:inline-block;float:right;margin:-.15rem 0"><link rel="stylesheet" href="https://gcore.jsdelivr.net/gh/zyxelva/zyxelva.github.io@main/libs/share/css/share.min.css"><div id="article-share"><div class="social-share" data-sites="google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div><script src="https://gcore.jsdelivr.net/gh/zyxelva/zyxelva.github.io@main/libs/share/js/social-share.min.js"></script></div></div></div><div id="reward"><a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">赏</a><div id="rewardModal" class="modal"><div class="modal-content"><a class="close modal-close"><i class="fas fa-times"></i></a><h4 class="reward-title">你的赏识是我前进的动力</h4><div class="reward-content"><div class="reward-tabs"><ul class="tabs row"><li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li><li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li></ul><div id="alipay"><img src="https://gcore.jsdelivr.net/gh/zyxelva/zyxelva.github.io@main/medias/reward/alipay.jpg" class="reward-img" alt="支付宝打赏二维码"></div><div id="wechat"><img src="https://gcore.jsdelivr.net/gh/zyxelva/zyxelva.github.io@main/medias/reward/wechat.png" class="reward-img" alt="微信打赏二维码"></div></div></div></div></div></div><script>$(function(){$(".tabs").tabs()})</script></div></div><style>.twikoo-card{margin:1.5rem auto}.twikoo-card .card-content{padding:20px}#tcomments textarea{box-sizing:border-box;background:url("/") 100% 100% no-repeat}#tcomments p{margin:2px 2px 10px;font-size:1.05rem;line-height:1.78rem;text-align:left}#tcomments blockquote p{text-indent:.2rem}#tcomments a{padding:0 2px;color:#4cbf30;font-weight:500;text-decoration:none}#tcomments img{max-width:100%;height:auto;cursor:pointer}#tcomments ol li{list-style-type:decimal}#tcomments ol,ul{display:block;padding-left:2em;word-spacing:0.05rem}#tcomments ul li,ol li{display:list-item;line-height:1.8rem;font-size:1rem}#tcomments ul li{list-style-type:disc}#tcomments ul ul li{list-style-type:circle}#tcomments table,td,th{padding:12px 13px;border:1px solid #dfe2e5}#tcomments table,td,th{border:0}table tr:nth-child(2n),thead{background-color:#fafafa}#tcomments table th{background-color:#f2f2f2;min-width:80px}#tcomments table td{min-width:80px}#tcomments h1{font-size:1.85rem;font-weight:700;line-height:2.2rem}#tcomments h2{font-size:1.65rem;font-weight:700;line-height:1.9rem}#tcomments h3{font-size:1.45rem;font-weight:700;line-height:1.7rem}#tcomments h4{font-size:1.25rem;font-weight:700;line-height:1.5rem}#tcomments h5{font-size:1.1rem;font-weight:700;line-height:1.4rem}#tcomments h6{font-size:1rem;line-height:1.3rem}#tcomments p{font-size:1rem;line-height:1.5rem}#tcomments hr{margin:12px 0;border:0;border-top:1px solid #ccc}#tcomments blockquote{margin:15px 0;border-left:5px solid #42b983;padding:1rem .8rem .3rem .8rem;color:#666;background-color:rgba(66,185,131,.1)}#tcomments pre{font-family:monospace,monospace;padding:1.2em;margin:.5em 0;background:#272822;overflow:auto;border-radius:.3em;tab-size:4}#tcomments code{font-family:monospace,monospace;padding:1px 3px;font-size:.92rem;color:#e96900;background-color:#f8f8f8;border-radius:2px}#tcomments pre code{font-family:monospace,monospace;padding:0;color:#e8eaf6;background-color:#272822}#tcomments pre[class*=language-]{padding:1.2em;margin:.5em 0}#tcomments code[class*=language-],pre[class*=language-]{color:#e8eaf6}#tcomments [type=checkbox]:not(:checked),[type=checkbox]:checked{position:inherit;margin-left:-1.3rem;margin-right:.4rem;margin-top:-1px;vertical-align:middle;left:unset;visibility:visible}#tcomments b,strong{font-weight:700}#tcomments dfn{font-style:italic}#tcomments small{font-size:85%}#tcomments cite{font-style:normal}#tcomments mark{background-color:#fcf8e3;padding:.2em}#tcomments table,td,th{padding:12px 13px;border:1px solid #dfe2e5}table tr:nth-child(2n),thead{background-color:#fafafa}#tcomments table th{background-color:#f2f2f2;min-width:80px}#tcomments table td{min-width:80px}#tcomments [type=checkbox]:not(:checked),[type=checkbox]:checked{position:inherit;margin-left:-1.3rem;margin-right:.4rem;margin-top:-1px;vertical-align:middle;left:unset;visibility:visible}</style><div class="card twikoo-card" data-aos="fade-up"><div class="comment_headling" style="font-size:20px;font-weight:700;position:relative;padding-left:20px;top:15px;padding-bottom:5px"><i class="fas fa-comments fa-fw" aria-hidden="true"></i> <span>评论</span></div><div class="card-content" style="display:grid"><div id="tcomments"></div></div></div><script src="https://gcore.jsdelivr.net/npm/twikoo/dist/twikoo.all.min.js"></script><script>twikoo.init({envId:"https://kezadetwikoo.netlify.app/.netlify/functions/twikoo",el:"#tcomments",region:"",path:""}).then(function(){for(var t=document.querySelector("#twikoo").getElementsByTagName("input"),e=0;e<t.length;e++)t[e]&&t[e].classList.add("browser-default")})</script><article id="prenext-posts" class="prev-next articles"><div class="row article-row"><div class="article col s12 m6" data-aos="fade-up"><div class="article-badge left-badge text-color"><i class="fas fa-chevron-left"></i> &nbsp;上一篇</div><div class="card"><a href="/posts/4073118876.html"><div class="card-image"><img src="/medias/LeetCode.jpg" class="responsive-img" alt="【LeetCode】513.找树左下角的值"> <span class="card-title">【LeetCode】513.找树左下角的值</span></div></a><div class="card-content article-content"><div class="summary block-with-text"></div><div class="publish-info"><span class="publish-date"><i class="far fa-clock fa-fw icon-date"></i> 2023-07-20</span><span class="publish-author"><i class="fas fa-bookmark fa-fw icon-category"></i> <a href="/categories/%E7%AE%97%E6%B3%95/" class="post-category">算法</a></span></div></div><div class="card-action article-tags"><a href="/tags/LeetCode/"><span class="chip bg-color">LeetCode</span></a> <a href="/tags/DFS/"><span class="chip bg-color">DFS</span></a> <a href="/tags/BFS/"><span class="chip bg-color">BFS</span></a></div></div></div><div class="article col s12 m6" data-aos="fade-up"><div class="article-badge right-badge text-color">下一篇&nbsp;<i class="fas fa-chevron-right"></i></div><div class="card"><a href="/posts/1040968382.html"><div class="card-image"><img src="/medias/RocketMQ2.png" class="responsive-img" alt="【RocketMQ学习】3.RocketMQ的存储设计"> <span class="card-title">【RocketMQ学习】3.RocketMQ的存储设计</span></div></a><div class="card-content article-content"><div class="summary block-with-text"></div><div class="publish-info"><span class="publish-date"><i class="far fa-clock fa-fw icon-date"></i> 2023-07-17</span><span class="publish-author"><i class="fas fa-bookmark fa-fw icon-category"></i> <a href="/categories/RocketMQ%E5%AD%A6%E4%B9%A0/" class="post-category">RocketMQ学习</a></span></div></div><div class="card-action article-tags"><a href="/tags/RocketMQ/"><span class="chip bg-color">RocketMQ</span></a> <a href="/tags/DDD/"><span class="chip bg-color">DDD</span></a> <a href="/tags/%E5%AD%98%E5%82%A8%E7%BB%93%E6%9E%84/"><span class="chip bg-color">存储结构</span></a></div></div></div></div></article></div><script>$("#articleContent").on("copy",function(e){if(void 0!==window.getSelection){var n=window.getSelection();if(!((""+n).length<Number.parseInt("120"))){var t=document.getElementsByTagName("body")[0],o=document.createElement("div");o.style.position="absolute",o.style.left="-99999px",t.appendChild(o),o.appendChild(n.getRangeAt(0).cloneContents()),"PRE"!==n.getRangeAt(0).commonAncestorContainer.nodeName&&"CODE"!==n.getRangeAt(0).commonAncestorContainer.nodeName||(o.innerHTML="<pre>"+o.innerHTML+"</pre>");var i=document.location.href;o.innerHTML+='<br />来源: Kezade<br />文章作者: Kezade<br />文章链接: <a href="'+i+'">'+i+"</a><br />本文章著作权归作者所有，任何形式的转载都请注明出处。",n.selectAllChildren(o),window.setTimeout(function(){t.removeChild(o)},200)}}})</script><script src="https://gcore.jsdelivr.net/gh/zyxelva/zyxelva.github.io@main/libs/codeBlock/codeBlockFuction.js"></script><script src="https://gcore.jsdelivr.net/gh/zyxelva/zyxelva.github.io@main/libs/prism/prism.min.js"></script><script src="https://gcore.jsdelivr.net/gh/zyxelva/zyxelva.github.io@main/libs/codeBlock/codeLang.js"></script><script src="https://gcore.jsdelivr.net/gh/zyxelva/zyxelva.github.io@main/libs/codeBlock/codeCopy.js"></script><script src="https://gcore.jsdelivr.net/gh/zyxelva/zyxelva.github.io@main/libs/codeBlock/codeShrink.js"></script></div><div id="toc-aside" class="expanded col l3 hide-on-med-and-down"><div class="toc-widget card" style="background-color:#fff"><div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div><div id="toc-content"></div></div></div></div><div id="floating-toc-btn" class="hide-on-med-and-down"><a class="btn-floating btn-large bg-color"><i class="fas fa-list-ul"></i></a></div><script src="https://gcore.jsdelivr.net/gh/zyxelva/zyxelva.github.io@main/libs/tocbot/tocbot.min.js"></script><script>$(function(){tocbot.init({tocSelector:"#toc-content",contentSelector:"#articleContent",headingsOffset:-(.4*$(window).height()-45),collapseDepth:Number("0"),headingSelector:"h1, h2, h3, h4, h5"});let t=parseInt(.4*$(window).height()-64),e=$(".toc-widget");$(window).scroll(function(){$(window).scrollTop()>t?e.addClass("toc-fixed"):e.removeClass("toc-fixed")});const o="expanded";let n=$("#toc-aside"),i=$("#main-content");$("#floating-toc-btn .btn-floating").click(function(){n.hasClass(o)?(n.removeClass(o).hide(),i.removeClass("l9")):(n.addClass(o).show(),i.addClass("l9")),function(t,e){let o=$("#"+t);if(0===o.length)return;let n=o.width();n+=n>=450?21:n>=350&&n<450?18:n>=300&&n<350?16:14,$("#"+e).width(n)}("artDetail","prenext-posts")})})</script></main><footer class="page-footer bg-color"><div class="container row center-align" style="margin-bottom:15px!important"><div class="col s12 m8 l8 copy-right">Copyright&nbsp;&copy; <span id="year">2019-2025</span> <a href="/about" target="_blank">Kezade</a> |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a> |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a><br><br><span id="sitetime">Loading ...</span><script>var calcSiteTime=function(){var e=6e4,t=36e5,n=864e5,a=365*n,i=new Date,r="2019",o=i.getFullYear(),s=i.getMonth()+1,l=i.getDate(),m=i.getHours(),c=i.getMinutes(),d=i.getSeconds(),g=Date.UTC(r,"6","28","0","0","0"),h=Date.UTC(o,s,l,m,c,d)-g,u=Math.floor(h/a),M=Math.floor(h/n-365*u),T=Math.floor((h-(365*u+M)*n)/t),f=Math.floor((h-(365*u+M)*n-T*t)/e),y=Math.floor((h-(365*u+M)*n-T*t-f*e)/1e3);if(r===String(o)){document.getElementById("year").innerHTML=o;var v="This site has been running for "+M+" days";v="本站已运行 "+M+" 天",document.getElementById("sitetime").innerHTML=v}else{document.getElementById("year").innerHTML=r+" - "+o;var H="This site has been running for "+u+" years and "+M+" days "+T+" hours "+f+" mins "+y+" seconds";H="本站已苟且偷生 "+u+" 年 "+M+" 天 "+T+" 小时 "+f+" 分钟 "+y+" 秒",document.getElementById("sitetime").innerHTML=H}};calcSiteTime(),setInterval(calcSiteTime,1e3)</script><br></div><div class="col s12 m4 l4 social-link"><a href="https://github.com/zyxelva" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50"><i class="fab fa-github"></i></a><a href="mailto:zyxelva@gmail.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50"><i class="fas fa-envelope-open"></i></a><a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=1807401971" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 1807401971" data-position="top" data-delay="50"><i class="fab fa-qq"></i></a> <a href="https://www.zhihu.com/people/kezade" class="tooltipped" target="_blank" data-tooltip="关注我的知乎: https://www.zhihu.com/people/kezade" data-position="top" data-delay="50"><i class="fab fa-zhihu1">知</i></a><a href="../rss2.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50"><i class="fas fa-rss"></i></a></div></div></footer><div class="progress-bar"></div><div id="searchModal" class="modal"><div class="modal-content"><div class="search-header"><span class="title"><i class="fas fa-search"></i> &nbsp;&nbsp;搜索</span> <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字" class="search-input"></div><div id="searchResult"></div></div></div><script>$(function(){!function(t,e,r){"use strict";$.ajax({url:t,dataType:"xml",success:function(t){var n=$("entry",t).map(function(){return{title:$("title",this).text(),content:$("content",this).text(),url:$("url",this).text()}}).get(),a=document.getElementById(e),s=document.getElementById(r);a.addEventListener("input",function(){var t='<ul class="search-result-list">',e=this.value.trim().toLowerCase().split(/[\s\-]+/);s.innerHTML="",this.value.trim().length<=0||(n.forEach(function(r){var n=!0,a=r.title.trim().toLowerCase(),s=r.content.trim().replace(/<[^>]+>/g,"").toLowerCase(),i=r.url;i=0===i.indexOf("/")?r.url:"/"+i;var l=-1,c=-1,u=-1;if(""!==a&&""!==s&&e.forEach(function(t,e){l=a.indexOf(t),c=s.indexOf(t),l<0&&c<0?n=!1:(c<0&&(c=0),0===e&&(u=c))}),n){t+="<li><a href='"+i+"' class='search-result-title'>"+a+"</a>";var o=r.content.trim().replace(/<[^>]+>/g,"");if(u>=0){var h=u-20,f=u+80;h<0&&(h=0),0===h&&(f=100),f>o.length&&(f=o.length);var m=o.substr(h,f);e.forEach(function(t){var e=new RegExp(t,"gi");m=m.replace(e,'<em class="search-keyword">'+t+"</em>")}),t+='<p class="search-result">'+m+"...</p>"}t+="</li>"}}),t+="</ul>",s.innerHTML=t)})}})}("/search.xml","searchInput","searchResult")})</script><div class="stars-con"><div id="stars"></div><div id="stars2"></div><div id="stars3"></div></div><script>function switchNightMode(){$('<div class="Cuteen_DarkSky"><div class="Cuteen_DarkPlanet"></div></div>').appendTo($("body")),setTimeout(function(){$("body").hasClass("DarkMode")?($("body").removeClass("DarkMode"),localStorage.setItem("isDark","0"),$("#sum-moon-icon").removeClass("fa-sun").addClass("fa-moon")):($("body").addClass("DarkMode"),localStorage.setItem("isDark","1"),$("#sum-moon-icon").addClass("fa-sun").removeClass("fa-moon")),setTimeout(function(){$(".Cuteen_DarkSky").fadeOut(1e3,function(){$(this).remove()})},2e3)})}</script><div id="backTop" class="top-scroll"><a class="btn-floating btn-large waves-effect waves-light" href="#!"><i class="fas fa-arrow-up"></i></a></div><script src="https://gcore.jsdelivr.net/gh/zyxelva/zyxelva.github.io@main/libs/materialize/materialize.min.js"></script><script src="https://gcore.jsdelivr.net/gh/zyxelva/zyxelva.github.io@main/libs/masonry/masonry.pkgd.min.js"></script><script src="https://gcore.jsdelivr.net/gh/zyxelva/zyxelva.github.io@main/libs/aos/aos.js"></script><script src="https://gcore.jsdelivr.net/gh/zyxelva/zyxelva.github.io@main/libs/scrollprogress/scrollProgress.min.js"></script><script src="https://gcore.jsdelivr.net/gh/zyxelva/zyxelva.github.io@main/libs/lightGallery/js/lightgallery-all.min.js"></script><script src="https://gcore.jsdelivr.net/gh/zyxelva/zyxelva.github.io@main/js/matery.js"></script><link rel="stylesheet" href="https://gcore.jsdelivr.net/gh/zyxelva/zyxelva.github.io@main/libs/mermaid/mermaid.min.css"><script src="https://gcore.jsdelivr.net/gh/zyxelva/zyxelva.github.io@main/libs/mermaid/mermaid.min.js"></script><script>window.mermaid&&mermaid.initialize({theme:"forest"})</script><script>!function(){var t=document.createElement("script"),e=window.location.protocol.split(":")[0];t.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(t,s)}()</script><script src="https://gcore.jsdelivr.net/gh/zyxelva/zyxelva.github.io@main/libs/background/ribbon-dynamic.js" async></script><script src="https://gcore.jsdelivr.net/gh/zyxelva/zyxelva.github.io@main/libs/instantpage/instantpage.js" type="module"></script></body></html>
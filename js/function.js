"use strict";var leonus={procMemosGalleries:(e,o,t,a)=>{if(!(o&&o.length>0))return"";let s="",r=[],i=0;return o.forEach(o=>{r=r.concat(o.content.match(/\!\[.*?\]\(.*?\)/g)).concat(leonus.procMemosResources(e,o))}),r.forEach(e=>{if(e&&i<t){i++;let o,t,r=e.replace(/!\[.*?\]\((.*?)\)/g,"$1"),n=e.replace(/!\[(.*?)\]\(.*?\)/g,"$1");-1!==n.indexOf(" ")?(o=n.split(" ")[0],t=n.split(" ")[1]):t=n,s+=`<div class="${a}"><a href="${r}" data-fancybox="gallery" class="fancybox" data-thumb="${r}"><img alt="${n}" class="photo-img" loading='lazy' decoding="async" src="${r}"></a>`,t&&(s+=`<span class="photo-title">${t}</span>`),o&&(s+=`<span class="photo-time">${o}</span>`),s+="</div>"}}),s},procMemosResources:(e,o)=>{if(!(o&&o.resourceList&&0<o.resourceList.length&&e))return"";let t=o.content.replace("\n","").split(" "),a=t[t.length-1],s=o.resourceList,r="";for(var i=0;i<s.length;i++){var n=s[i].type.slice(0,5),l=s[i].externalLink,c="",m="",d=new Date(1e3*s[i].createdTs),g=[d.getFullYear(),d.getMonth()+1,d.getDate()].join("-");l?c=l:(m=s[i].publicId||s[i].filename,c=e+"o/r/"+s[i].id+"/"+m),"image"===n&&(r+=a?`![${g} ${a}](${c})`:`![${g}](${c})`)}return r.match(/\!\[.*?\]\(.*?\)/g)},procBiBi:(e,o,t,a)=>{var s="";let r=[];if(r=r.concat(o.content.match(/\!\[.*?\]\(.*?\)/g)),r&&r.length>0){let e="";r.forEach(o=>{if(o){let a=o.replace(/!\[.*?\]\((.*?)\)/g,"$1"),s=o.replace(/!\[(.*?)\]\(.*?\)/g,"$1");e+=`<div class="${t}"><a href="${a}" data-fancybox="gallery" class="fancybox" data-thumb="${a}"><img alt="${s}" loading="lazy" src="${a}"/></a></div>`}}),e&&(s+=`<div class="resource-wrapper "><div class="images-wrapper">${e}</div></div>`)}if(o&&o.resourceList&&o.resourceList.length>0){for(var i=o.resourceList,n="",l="",c=0;c<i.length;c++){var m,d=i[c].type.slice(0,5),g=i[c].externalLink,u="";g?u=g:(m=i[c].publicId||i[c].filename,u=e+"o/r/"+i[c].id+"/"+m),"image"===d&&(n+=`<div class="resimg"><a href="${u}" data-fancybox="gallery" class="fancybox" data-thumb="${u}"><img loading="lazy" src="${u}"/></a></div>`,1),"image"!==d&&(l+='<a target="_blank" rel="noreferrer" href="'+u+'">'+i[c].filename+"</a>")}n&&(s+=`<div class="resource-wrapper "><div class="images-wrapper">${n}</div></div>`),l&&(s+=`<div class="resource-wrapper "><p class="datasource">${l}</p></div>`)}let p=o.id;return s+=`<div class="memos__comments"><a class="artalk-div"onclick="leonus.loadTwikoo('${e}', ${p}, '${a}')" rel="noopener noreferrer" title="评论"><i class="fas fa-comment-dots fa-fw"></i></a><a onclick="leonus.transPond(${leonus.getMemosForm(e,o)})" rel="noopener noreferrer" title="转发"><i class="fa-solid fa-share-from-square"></i></a></div><div id="memos_${p}"class='twikoo-body item-content d-none'></div>`},loadTwikoo:(e,o,t)=>{var a=document.querySelector("#memos_"+o);a.classList.contains("d-none")?(document.querySelectorAll(".twikoo-body").forEach(e=>{e.classList.add("d-none")}),document.getElementById("twikoo")&&document.getElementById("twikoo").remove(),a.insertAdjacentHTML("beforeend","<div id='twikoo'></div>"),a.classList.remove("d-none"),twikoo.init({envId:t,el:"#twikoo",path:e+"/m/"+o})):(a.classList.add("d-none"),document.getElementById("twikoo").remove())},formatTimestamp:e=>{if(e){let o=new Date(1e3*e),t=o.getFullYear(),a=o.getMonth()+1<10?`0${o.getMonth()+1}`:o.getMonth()+1,s=o.getDate()<10?`0${o.getDate()}`:o.getDate(),r=o.getHours()<10?`0${o.getHours()}`:o.getHours(),i=o.getMinutes()<10?`0${o.getMinutes()}`:o.getMinutes(),n=o.getSeconds()<10?`0${o.getSeconds()}`:o.getSeconds();return(new Date).getFullYear()===t?`${a}-${s} ${r}:${i}:${n}`:`${t}-${a}-${s} ${r}:${i}:${n}`}return""},memoGoods:(e,o)=>{let t=e||30;var a={host:"https://demo.usememos.com/",limit:"10",creatorId:"101",domId:"#memos",username:"Admin",name:"Administrator",path:""};if("undefined"!=typeof memos)for(var s in memos)memos[s]&&(a[s]=memos[s]);var r=a.host+a.path+"?creatorId="+a.creatorId+"&tag=好物",i=JSON.parse(localStorage.getItem("goodsUpdated"))||"",n=JSON.parse(localStorage.getItem("goodsData"))||"";n?(leonus.loadGoods(n,t,a.host,o),console.log("memosGoods 本地数据加载成功")):localStorage.setItem("goodsUpdated",""),fetch(r).then(e=>e.json()).then(e=>{var s=e[0].updatedTs;if(s&&i!==s){var r=e;leonus.loadGoods(r,t,a.host,o),localStorage.setItem("goodsUpdated",JSON.stringify(s)),localStorage.setItem("goodsData",JSON.stringify(r)),console.log("memosGoods 热更新完成")}else console.log("memosGoods API 数据未更新")})},loadGoods:(e,o,t,a)=>{let s=1;const r=/\n/;for(var i,n="",l=0;l<e.length&&l<o;l++)if(s<=o){var c=e[l].content.replace("#好物 \n","").split(r);if(e[l].resourceList&&e[l].resourceList.length>0)for(var m=e[l].resourceList,d=0;d<m.length;d++){var g=m[d].type.slice(0,5),u=m[d].externalLink,p="",v="";u?p=u:(v=m[d].publicId||m[d].filename,p=t+"o/r/"+m[d].id+"/"+v),"image"===g&&s<=o&&(n+='<div class="goods-bankuai img-hide"><div class="goods-duiqi memos-photo"><a href="${resLink}" data-fancybox="gallery" class="fancybox" data-thumb="${resLink}" rel="noreferrer noopener nofollow"><img loading="lazy" decoding="async" src="'+p+'"/></a></div><div class="goods-jiage">'+c[0]+'</div><div class="goods-title">'+c[1].replace(/\[(.*?)\]\((.*?)\)/g,' <a href="$2" target="_blank">$1</a> ')+'</div><div class="goods-note">'+c[2]+"</div></div>",s++)}var h=c[1].replace(/\[(.*?)\]\((.*?)\)/g,"$1"),f=c[1].replace(/\[(.*?)\]\((.*?)\)/g,"$2");n+=`<div class="goods-bankuai img-hide"><div class="goods-duiqi  memos-photo"><a href="${f}" data-fancybox="gallery" class="fancybox" data-thumb="${f}"><img class="photo-img" loading="lazy" decoding="async" src="${f}" /></a></div><div class="goods-jiage">${c[0]}</div><div class="goods-title"><a href="${f}" target="_blank">${h}</a></div><div class="goods-note">${c[2]}</div></div>`,s++}i=n,a.innerHTML=i},getMemosForm:(e,o)=>{let t=o.content.replace(/#([^\s#]+?)\s/g,"").replace(/\!\[(.*?)\]\((.*?)\)/g,"").replace(/\[(.*?)\]\((.*?)\)/g,"$1").replace(/\n/g," ").replace(/\>.*$/g,"").replace(/\```.*$/g,"");t.length>140&&(t=t.substring(0,140)+"...");let a={id:o.id,creatorName:o.creatorName,content:t,url:e+"m/"+o.id};return JSON.stringify(a).replace(/"/g,"&quot;")},transPond:e=>{if(!leonus.openMemosEditForm(!0))return;localStorage.setItem("relationList",JSON.stringify([{relatedMemoId:e.id,type:"REFERENCE"}]));const o=document.querySelector(".common-editor-inputer");o.value="[@"+e.creatorName+"]("+e.url+") \n\n> "+e.creatorName+": "+e.content,o.style.height=o.scrollHeight+"px",document.body.scrollIntoView({behavior:"smooth"})},getBtnSet:(e,o,t)=>{let a="",s=localStorage.getItem("apiUrl")||"";if(s){var r=new URL(s),i=new URL(e).origin,n=t?"取消置顶":"置顶";r.origin&&r.origin===i&&(a+=`<a class="btn3" onclick="leonus.memosPin('${s}', ${o}, ${!t})" rel="noopener noreferrer" title="${n}">\n                            <i class="fa-solid fa-thumbtack"></i>${n}\n                        </a>`,a+=`<a class="btn3" onclick="leonus.memosEdit('${s}', ${o})" rel="noopener noreferrer" title="编辑">\n                            <i class="fa-regular fa-pen-to-square"></i>编辑\n                        </a>`,a+=`<a class="btn3" onclick="leonus.memosArchive('${s}', ${o})" rel="noopener noreferrer" title="归档">\n                            <i class="fas fa-archive"></i>归档\n                        </a>`,a+=`<a class="btn3" onclick="leonus.memosDelete('${s}', ${o})" rel="noopener noreferrer" title="删除">\n                            <i class="fa-regular fa-trash-can"></i>删除\n                        </a>`)}return a},openMemosEditForm:function(e){if(e){var o=document.querySelector("#memoPage");o.classList.contains("d-none")&&(o.classList.remove("d-none"),localStorage.setItem("memos-editor-display",!0))}return window.localStorage&&window.localStorage.getItem("apiUrl")?!(!window.localStorage||!window.localStorage.getItem("memos-access-token"))||($.message({message:"请先填写好 API token!"}),!1):($.message({message:"请先填写好 API Url!"}),!1)},memosPin:(e,o,t)=>{if(leonus.openMemosEditForm(!0)){var a=localStorage.getItem("memos-access-token"),s=e.replace(/api\/v1\/memo(.*)/,memos.path+"/"+o+"/organizer$1")||"";if(s&&o){var r={pinned:t};fetch(s,{method:"POST",body:JSON.stringify(r),headers:{Authorization:`Bearer ${a}`,"Content-Type":"application/json"}}).then(function(e){200===e.status&&($.message({message:t?"置顶成功":"取消置顶成功"}),location.reload())}).catch(e=>{$.message({message:"归档出错了，再检查一下吧"})})}}},memosEdit:(e,o)=>{if(leonus.openMemosEditForm(!0)){document.querySelector(".memos-image-list").innerHTML="";var t=document.querySelector(".common-editor-inputer");document.querySelector("#content_submit_text").classList.add("d-none"),document.querySelector(".edit-memos").classList.remove("d-none");var a=e.replace(/api\/v1\/memo(.*)/,memos.path+"/"+o+"$1")||"",s=localStorage.getItem("memos-access-token");a&&o&&fetch(a,{method:"GET",headers:{Authorization:`Bearer ${s}`,"Content-Type":"application/json"}}).then(e=>e.json()).then(e=>{if(localStorage.setItem("memos-resource-list",e.resourceList),localStorage.setItem("memos-edit-url",a),localStorage.setItem("memos-edit-id",o),t.value=e.content,leonus.editVisibility(e.visibility),e.resourceList&&e.resourceList.length>0){let o="",t=[];for(var s=0;s<e.resourceList.length;s++)o+='<div data-id="'+e.resourceList[s].id+'" class="memos-tag" onclick="leonus.deleteImage(this)"><div class="px-2 justify-content-center">'+e.resourceList[s].filename+"</div></div>",t.push(e.resourceList[s].id);localStorage.setItem("resourceIdList",JSON.stringify(t)),document.querySelector(".memos-image-list").insertAdjacentHTML("afterbegin",o)}t.style.height=t.scrollHeight+"px",document.body.scrollIntoView({behavior:"smooth"})})}},memosArchive:(e,o)=>{if(leonus.openMemosEditForm(!1)){var t=localStorage.getItem("memos-access-token"),a=e.replace(/api\/v1\/memo(.*)/,memos.path+"/"+o+"$1")||"";if(a&&o){var s={id:o,rowStatus:"ARCHIVED"};fetch(a,{method:"PATCH",body:JSON.stringify(s),headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"}}).then(function(e){200===e.status&&($.message({message:"归档成功"}),location.reload())}).catch(e=>{$.message({message:"归档出错了，再检查一下吧"})})}}},memosDelete:(e,o)=>{if(leonus.openMemosEditForm(!1)){var t=localStorage.getItem("memos-access-token"),a=e.replace(/api\/v1\/memo(.*)/,memos.path+"/"+o+"$1")||"";a&&o&&$.confirm({title:"Warning!",content:"确认删除该条数据?",theme:"supervan",closeIcon:!0,animation:"scale",type:"red",icon:"glyphicon glyphicon-question-sign",buttons:{ok:{text:"确认",btnClass:"btn-primary",action:function(){fetch(a,{method:"DELETE",headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"}}).then(function(e){200===e.status&&($.message({message:"删除成功"}),location.reload())}).catch(e=>{console.warn("Error msg: "+e),$.message({message:"删除出错了，再检查一下吧"})})}},cancel:{text:"取消",btnClass:"btn-primary"}}})}},editSubmit:()=>{var e=localStorage.getItem("memos-edit-url");if(!e){var o=localStorage.getItem("memos-edit-id");let t=localStorage.getItem("apiUrl")||"";if(!o||!t)return void console.log("memosId of edited memos or memosDomain is null.");e=t.replace(/api\/v1\/memo(.*)/,memos.path+"/"+o+"$1")||""}var t=localStorage.getItem("memos-access-token"),a=document.querySelector("#content_submit_text"),s=document.querySelector(".edit-memos");let r={content:document.querySelector(".common-editor-inputer").value,relationList:[],resourceIdList:JSON.parse(localStorage.getItem("resourceIdList")),visibility:localStorage.getItem("memoLock")};fetch(e,{method:"PATCH",body:JSON.stringify(r),headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"}}).then(function(e){200===e.status&&($.message({message:"编辑成功"}),a.classList.remove("d-none"),s.classList.add("d-none"),localStorage.removeItem("resourceIdList"),localStorage.removeItem("contentNow"),localStorage.removeItem("memos-edit-url"),localStorage.removeItem("memos-edit-id"),localStorage.removeItem("memos-resource-list"),location.reload())})},cancelEdit:()=>{var e=document.querySelector(".common-editor-inputer"),o=document.querySelector(".edit-memos");o.classList.contains("d-none")||(e.value="",e.style.height="inherit",o.classList.add("d-none"),document.querySelector("#content_submit_text").classList.remove("d-none"),document.querySelector(".memos-image-list").innerHTML="",localStorage.removeItem("resourceIdList"),localStorage.removeItem("memos-resource-list"),localStorage.removeItem("contentNow"),localStorage.removeItem("relationList"),localStorage.removeItem("memos-edit-url"),localStorage.removeItem("memos-edit-id"))},deleteImage:e=>{if(e){let o=e.getAttribute("data-id"),t=(window.localStorage&&JSON.parse(window.localStorage.getItem("resourceIdList"))).filter(function(e){return e!=o});window.localStorage&&window.localStorage.setItem("resourceIdList",JSON.stringify(t)),e.remove()}},editVisibility:e=>{let o=e||"PUBLIC",t="所有人可见";"PUBLIC"==o?t="所有人可见":"PRIVATE"==o?t="仅自己可见":"PROTECTED"==o&&(t="登录用户可见"),localStorage.setItem("memoLock",o),document.querySelector("#lock-now").value=t}};
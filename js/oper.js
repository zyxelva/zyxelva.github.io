var apiUrl=localStorage.getItem("apiUrl")||"",memosToken=localStorage.getItem("memos-access-token")||"",memoLock=localStorage.getItem("memoLock")||"",contentNow=localStorage.getItem("contentNow")||"",hidetag=localStorage.getItem("hidetag")||"",showtag=localStorage.getItem("showtag")||"";$("#hideInput").val(hidetag),$("#showInput").val(showtag);const apiReg=/openId=([^&]*)/,urlReg=/(.+?)(?:\/api)/;function initDrag(){var e=null,t=$("textarea[name=text]")[0];t.ondragenter=function(e){"common-editor-inputer"===e.target.className&&($.message({message:"拖拽到窗口上传该图片",autoClose:!1}),$("body").css("opacity",.3)),e.dataTransfer.dropEffect="copy"},t.ondragover=function(e){e.preventDefault(),e.dataTransfer.dropEffect="copy"},t.ondrop=function(t){$("body").css("opacity",1),t.preventDefault();for(var a=t.dataTransfer.files||t.target.files,o=0;o<a.length;o++)e=a[o];uploadImage(e)},t.ondragleave=function(e){e.preventDefault(),"common-editor-inputer"===e.target.className&&(console.log("ondragleave"+e.target.tagName),$.message({message:"取消上传"}),$("body").css("opacity",1))}}""==apiUrl||""==memosToken?$("#blog_info").show():($("#blog_info").hide(),$("#apiUrl").val(apiUrl),$("#apiToken").val(memosToken)),memoLock?"PUBLIC"==memoLock?$("#lock-now").text("所有人可见"):"PRIVATE"==memoLock?$("#lock-now").text("仅自己可见"):"PROTECTED"==memoLock&&$("#lock-now").text("登录用户可见"):(localStorage.setItem("memoLock","PUBLIC"),$("#lock-now").text("所有人可见")),contentNow&&$("textarea[name=text]").val(contentNow),$("textarea[name=text]").blur(function(){localStorage.setItem("contentNow",$("textarea[name=text]").val())}),$("textarea[name=text]").on("keydown",function(e){"Enter"===e.code&&(e.ctrlKey||e.metaKey)&&$("#content_submit_text").click()}),initDrag(),document.addEventListener("paste",function(e){let t=null;e.clipboardData.files[0]?t=e.clipboardData.files[0]:e.clipboardData.items[0]&&e.clipboardData.items[0].getAsFile()&&(t=e.clipboardData.items[0].getAsFile()),null!=t&&uploadImage(t)});let relistNow=[];function uploadImage(e){$.message({message:"上传图片中……",autoClose:!1});const t=new FormData;if(localStorage.getItem("apiUrl")){let a=e.name.split("."),o=e.name.split(".").pop(),l=dayjs().format("YYYYMMDDHHmm"),i=a[0]+"_"+l+"."+o,s=[];apiUrl=localStorage.getItem("apiUrl"),t.append("file",e,i),$.ajax({url:apiUrl.replace(/api\/v1\/memo/,"api/v1/resource/blob"),data:t,type:"post",cache:!1,processData:!1,contentType:!1,dataType:"json",success:function(e){if(console.log(e),e.id){let t="";t+='<div data-id="'+e.id+'" class="memos-tag" onclick="leonus.deleteImage(this)"><div class="px-2 justify-content-center">'+e.filename+"</div></div>",document.querySelector(".memos-image-list").insertAdjacentHTML("afterbegin",t),JSON.parse(localStorage.getItem("resourceIdList"))&&(s=JSON.parse(localStorage.getItem("resourceIdList"))),s.push(e.id),localStorage.setItem("resourceIdList",JSON.stringify(s)),$.message({message:"上传成功"})}else localStorage.removeItem("resourceIdList"),$.message({message:"上传图片失败"})}})}else $.message({message:"所需要信息不足，请先填写好绑定信息"})}function getOne(e){if(localStorage.getItem("apiUrl")){apiUrl=localStorage.getItem("apiUrl"),$("#randomlist").html("").hide();var t=apiUrl.replace(/api\/v1\/memo(.*)/,memos.path+"/"+e+"$1");$.get(t,function(e){updateHTMl([e],!0)})}else $.message({message:"请先填写好 API 链接"})}function randDom(e){apiUrl=localStorage.getItem("apiUrl");var t='<div class="random-item"><div class="random-time"><span id="random-link" data-id="'+e.id+'"><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" width="32" height="32"><path d="M864 640a32 32 0 0 1 64 0v224.096A63.936 63.936 0 0 1 864.096 928H159.904A63.936 63.936 0 0 1 96 864.096V159.904C96 124.608 124.64 96 159.904 96H384a32 32 0 0 1 0 64H192.064A31.904 31.904 0 0 0 160 192.064v639.872A31.904 31.904 0 0 0 192.064 864h639.872A31.904 31.904 0 0 0 864 831.936V640zm-485.184 52.48a31.84 31.84 0 0 1-45.12-.128 31.808 31.808 0 0 1-.128-45.12L815.04 166.048l-176.128.736a31.392 31.392 0 0 1-31.584-31.744 32.32 32.32 0 0 1 31.84-32l255.232-1.056a31.36 31.36 0 0 1 31.584 31.584L924.928 388.8a32.32 32.32 0 0 1-32 31.84 31.392 31.392 0 0 1-31.712-31.584l.736-179.392L378.816 692.48z" fill="#666" data-spm-anchor-id="a313x.7781069.0.i12" class="selected"/></svg></span><span id="random-delete" data-id="'+e.id+'"><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" width="32" height="32"><path d="M224 322.6h576c16.6 0 30-13.4 30-30s-13.4-30-30-30H224c-16.6 0-30 13.4-30 30 0 16.5 13.5 30 30 30zm66.1-144.2h443.8c16.6 0 30-13.4 30-30s-13.4-30-30-30H290.1c-16.6 0-30 13.4-30 30s13.4 30 30 30zm339.5 435.5H394.4c-16.6 0-30 13.4-30 30s13.4 30 30 30h235.2c16.6 0 30-13.4 30-30s-13.4-30-30-30z" fill="#666"/><path d="M850.3 403.9H173.7c-33 0-60 27-60 60v360c0 33 27 60 60 60h676.6c33 0 60-27 60-60v-360c0-33-27-60-60-60zm-.1 419.8l-.1.1H173.9l-.1-.1V464l.1-.1h676.2l.1.1v359.7z" fill="#666"/></svg></span>'+dayjs(1e3*new Date(e.createdTs)).fromNow()+'</div><div class="random-content">'+e.content.replace(/!\[.*?\]\((.*?)\)/g,' <img class="random-image" src="$1"/> ').replace(/\[(.*?)\]\((.*?)\)/g,' <a href="$2" target="_blank">$1</a> ')+"</div>";if(e.resourceList&&e.resourceList.length>0)for(var a=e.resourceList,o=0;o<a.length;o++){var l=a[o].type.slice(0,5),i=a[o].externalLink,s="";s=i||apiUrl.replace(/api\/v1\/memo.*/,"")+"o/r/"+a[o].id+"/"+a[o].filename,"image"==l&&(t+='<img class="random-image" src="'+s+'"/>'),"image"!==l&&(t+='<a target="_blank" rel="noreferrer" href="'+s+'">'+a[o].filename+"</a>")}t+="</div>",window.ViewImage&&ViewImage.init(".random-image"),$("#randomlist").html(t).slideDown(500)}function add(e){var t=document.getElementById("content"),a=t.value.length;t.focus(),void 0!==document.selection?document.selection.createRange().text=e:t.value=t.value.substr(0,t.selectionStart)+e+t.value.substring(t.selectionStart,a)}function sendText(){if(localStorage.getItem("apiUrl")&&localStorage.getItem("memos-access-token")){apiUrl=localStorage.getItem("apiUrl"),memosToken=localStorage.getItem("memos-access-token"),$.message({message:"发送中～～"});let i=$("textarea[name=text]").val();var e=localStorage.getItem("hidetag")||"",t=localStorage.getItem("showtag")||"",a=$("textarea[name=text]").val().match(/(#[^\s#]+)/),o=localStorage.getItem("memoLock")||"",l=JSON.parse(localStorage.getItem("relationList"))||[];a&&(a[1]==t?o="PUBLIC":a[1]==e&&(o="PRIVATE")),$.ajax({url:apiUrl,type:"POST",data:JSON.stringify({content:i,visibility:o,resourceIdList:JSON.parse(localStorage.getItem("resourceIdList"))||[],relationList:l}),headers:{Accept:"application/json",Authorization:`Bearer ${memosToken}`},contentType:"application/json;",dataType:"json",success:function(e){getOne(e.id),document.querySelector(".memos-image-list").innerHTML="",localStorage.removeItem("memos-resource-list"),localStorage.removeItem("resourceIdList"),localStorage.removeItem("contentNow"),localStorage.removeItem("relationList"),$.message({message:"发送成功！😊"}),$("textarea[name=text]").val("")},error:function(e){localStorage.removeItem("resourceIdList"),$.message({message:"网络问题，发送失败！😭（记得点下小锁图标，设置一下状态哦）"})}})}else $.message({message:"请先填写好 API 相关信息！"})}$("#saveKey").click(function(){let e=$("#apiUrl").val(),t=$("#apiToken").val(),a=e.match(urlReg)[1];localStorage.setItem("apiUrl",e),localStorage.setItem("memos-access-path",a),localStorage.setItem("memos-access-token",t),$.message({message:"保存信息成功"}),$("#blog_info").hide()}),$("#opensite").click(function(){window.location.href=apiUrl.replace(/api\/v1\/memo.*/,"")}),$("#tags1").click(function(){if(localStorage.getItem("apiUrl")){var e=(apiUrl=localStorage.getItem("apiUrl")).replace(/api\/v1\/memo/,"api/v1/tag"),t=localStorage.getItem("memos-access-token"),a="";fetch(e,{method:"GET",headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"}}).then(e=>e.json()).then(e=>{$.each(e,function(e,t){a+='<span class="item-container">#'+t+"</span>"}),a+='<svg id="hideTag" class="hidetag" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" width="24" height="24"><path d="M78.807 362.435c201.539 314.275 666.962 314.188 868.398-.241 16.056-24.99 13.143-54.241-4.04-62.54-17.244-8.377-40.504 3.854-54.077 24.887-174.484 272.338-577.633 272.41-752.19.195-13.573-21.043-36.874-33.213-54.113-24.837-17.177 8.294-20.06 37.545-3.978 62.536z" fill="#fff"/><path d="M894.72 612.67L787.978 494.386l38.554-34.785 106.742 118.251-38.554 34.816zM635.505 727.51l-49.04-147.123 49.255-16.41 49.054 147.098-49.27 16.435zm-236.18-12.001l-49.568-15.488 43.29-138.48 49.557 15.513-43.28 138.455zM154.49 601.006l-38.743-34.565 95.186-106.732 38.763 34.566-95.206 106.731z" fill="#fff"/></svg>',$("#taglist").html(a).slideToggle(500)})}else $.message({message:"请先填写好 API 链接"})}),$(document).on("click","#hideTag",function(){$("#taghide").slideToggle(500)}),$("#saveTag").click(function(){localStorage.setItem("hidetag",$("#hideInput").val()),localStorage.setItem("showtag",$("#showInput").val()),$.message({message:"保存信息成功"}),$("#taghide").hide()}),dayjs.extend(window.dayjs_plugin_relativeTime),dayjs.locale("zh-cn"),$("#search").click(function(){if(localStorage.getItem("apiUrl")){apiUrl=localStorage.getItem("apiUrl"),$("#randomlist").html("").hide();var e="";const t=$("textarea[name=text]").val();t?$.get(apiUrl,function(a){for(var o=new Fuse(a,{keys:["content"]}).search(t),l=0;l<o.length;l++){if(e+='<div class="random-item"><div class="random-time"><span id="random-link" data-id="'+o[l].item.id+'"><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" width="32" height="32"><path d="M864 640a32 32 0 0 1 64 0v224.096A63.936 63.936 0 0 1 864.096 928H159.904A63.936 63.936 0 0 1 96 864.096V159.904C96 124.608 124.64 96 159.904 96H384a32 32 0 0 1 0 64H192.064A31.904 31.904 0 0 0 160 192.064v639.872A31.904 31.904 0 0 0 192.064 864h639.872A31.904 31.904 0 0 0 864 831.936V640zm-485.184 52.48a31.84 31.84 0 0 1-45.12-.128 31.808 31.808 0 0 1-.128-45.12L815.04 166.048l-176.128.736a31.392 31.392 0 0 1-31.584-31.744 32.32 32.32 0 0 1 31.84-32l255.232-1.056a31.36 31.36 0 0 1 31.584 31.584L924.928 388.8a32.32 32.32 0 0 1-32 31.84 31.392 31.392 0 0 1-31.712-31.584l.736-179.392L378.816 692.48z" fill="#666" data-spm-anchor-id="a313x.7781069.0.i12" class="selected"/></svg></span><span id="random-delete" data-id="'+o[l].item.id+'"><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" width="32" height="32"><path d="M224 322.6h576c16.6 0 30-13.4 30-30s-13.4-30-30-30H224c-16.6 0-30 13.4-30 30 0 16.5 13.5 30 30 30zm66.1-144.2h443.8c16.6 0 30-13.4 30-30s-13.4-30-30-30H290.1c-16.6 0-30 13.4-30 30s13.4 30 30 30zm339.5 435.5H394.4c-16.6 0-30 13.4-30 30s13.4 30 30 30h235.2c16.6 0 30-13.4 30-30s-13.4-30-30-30z" fill="#666"/><path d="M850.3 403.9H173.7c-33 0-60 27-60 60v360c0 33 27 60 60 60h676.6c33 0 60-27 60-60v-360c0-33-27-60-60-60zm-.1 419.8l-.1.1H173.9l-.1-.1V464l.1-.1h676.2l.1.1v359.7z" fill="#666"/></svg></span>'+dayjs(1e3*new Date(o[l].item.createdTs)).fromNow()+'</div><div class="random-content">'+o[l].item.content.replace(/!\[.*?\]\((.*?)\)/g,' <img class="random-image" src="$1"/> ').replace(/\[(.*?)\]\((.*?)\)/g,' <a href="$2" target="_blank">$1</a> ')+"</div>",o[l].item.resourceList&&o[l].item.resourceList.length>0)for(var i=o[l].item.resourceList,s=0;s<i.length;s++){var n=i[s].type.slice(0,5),c=i[s].externalLink,r="";r=c||apiUrl.replace(/api\/v1\/memo.*/,"")+"o/r/"+i[s].id+"/"+i[s].filename,"image"==n&&(e+='<img class="random-image" src="'+r+'"/>'),"image"!==n&&(e+='<a target="_blank" rel="noreferrer" href="'+r+'">'+i[s].filename+"</a>")}e+="</div>"}window.ViewImage&&ViewImage.init(".random-image"),$("#randomlist").html(e).slideDown(500)}):$.message({message:"想搜点啥？"})}else $.message({message:"请先填写好 API 链接"})}),$("#random").click(function(){if(localStorage.getItem("apiUrl")){apiUrl=localStorage.getItem("apiUrl"),$("#randomlist").html("").hide();var e=$("textarea[name=text]").val().replace(/#([^\s#]+)/,"$1");if($("#taglist").is(":visible")&&e){var t=apiUrl+"&rowStatus=NORMAL&tag="+e;$.get(t,function(e){randDom(e[Math.floor(Math.random()*e.length)])})}else{var a=apiUrl+"&rowStatus=NORMAL&limit=1";$.get(a,function(e){var t=e[0].creatorId,a=apiUrl.replace(/api\/v1\/memo.*/,memos.path+"/stats?creatorId=")+t;$.get(a,function(e){console.log(e.length);let t=Math.floor(Math.random()*e.length)+1;var a=apiUrl+"&rowStatus=NORMAL&limit=1&offset="+t;$.get(a,function(e){randDom(e[0])})})})}}else $.message({message:"请先填写好 API 链接"})}),$(document).on("click","#random-link",function(){window.location.href=apiUrl.replace(/api\/v1\/memo.*/,"")+"m/"+this.getAttribute("data-id")}),$(document).on("click","#random-delete",function(){var e=this.getAttribute("data-id"),t=apiUrl.replace(/api\/v1\/memo(.*)/,memos.path+"/"+e+"$1");$.ajax({url:t,type:"PATCH",data:JSON.stringify({id:e,rowStatus:"ARCHIVED"}),contentType:"application/json;",dataType:"json",success:function(e){$("#randomlist").html("").hide(),$.message({message:"归档成功！😊"})},error:function(e){$.message({message:"网络问题，归档失败！😭"})}})}),$("#lock").click(function(){$("#lock-wrapper").toggleClass("!hidden",1e3)}),$(document).on("click",".item-lock",function(){_this=$(this)[0].dataset.type,localStorage.setItem("memoLock",_this),$.message({message:"设置成功"}),$("#lock-wrapper").toggleClass("!hidden",1e3),$("#lock-now").text($(this).text())}),$(document).on("click",".item-container",function(){add($(this).text()+" ")}),$("#newtodo").click(function(){add("\n- [ ] ")}),$("#code").click(function(){add("```\n\n```")}),$("#link").click(function(){add("[]()\n")}),$("#upres").click(async function(){$("#inFile").click()}),$("#inFile").on("change",function(e){""!=$("#inFile").val()&&uploadImage(this.files[0])}),$("#blog_info_edit").click(function(){$("#blog_info").slideToggle()}),$("#content_submit_text").click(function(){$("textarea[name=text]").val()?sendText():$.message({message:"写点什么，再记呗？"})});